#!/bin/bash
############################################################################
# Script to identify the XML RPC services enabled on a WordPress instance
############################################################################
if [ "$#" -lt 1 ]; then
    script_name=$(basename "$0")
    echo "Usage:"
    echo "   $script_name [URL]"
    echo ""
    echo "Call example:"
    echo "    $script_name \"https://righettod.eu\""
    exit 1
fi
test_service () {
    service_name=$1
    target_host=$2
    request_xml_testA="<methodCall><methodName>$service_name</methodName><params><param><value>test</value></param></params></methodCall>"
    request_xml_testB="<methodCall><methodName>$service_name</methodName><params><param><value><array><data><value><int>1</int></value><value><string>test</string></value><value><string>test</string></value></data></array></value></param></params></methodCall>"
    request_xml_testC="<methodCall><methodName>$service_name</methodName><params><param><value><array><data><value><int>1</int></value><value><string>test</string></value><value><string>test</string></value><value><int>1</int></value></data></array></value></param></params></methodCall>"    
    is_disabled=$(curl -A "$USER_AGENT" -sk -d "$request_xml_testA" -X POST "$target_host/xmlrpc.php" | grep -ic "$DISABLED_MESSAGE_MARKER")
    # Perform the initial test with the body A
    if [ $is_disabled -eq 0 ]
    then
        # Confirm the state by performing the test with the body B
        is_disabled=$(curl -A "$USER_AGENT" -sk -d "$request_xml_testB" -X POST "$target_host/xmlrpc.php" | grep -ic "$DISABLED_MESSAGE_MARKER")
        if [ $is_disabled -eq 0 ]
        then
            # Confirm the state by performing the test with the body C
            is_disabled=$(curl -A "$USER_AGENT" -sk -d "$request_xml_testC" -X POST "$target_host/xmlrpc.php" | grep -ic "$DISABLED_MESSAGE_MARKER")
            if [ $is_disabled -eq 0 ]
            then
                http_code=$(curl -A "$USER_AGENT" -sk -d "$request_xml_testC" -X POST -o /dev/null -w "%{http_code}" "$target_host/xmlrpc.php")
                echo "[$http_code] $service_name"        
            fi
        fi
    fi
}
function write_step(){
    echo -e "\e[93m[+] $1\e[0m"
}
DISABLED_MESSAGE_MARKER="XML-RPC services are disabled on this site"
USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36"
WORK_FILE="/tmp/services.tmp"
base=$1
write_step "Check if the XML-RPC endpoint is enabled..."
xmlrpc_is_enabled=$(curl -A "$USER_AGENT" -sk -X GET "$base/xmlrpc.php" | grep -ic "XML-RPC server accepts POST requests only")
if [ $xmlrpc_is_enabled -ne 1 ]
then
    echo "Endpoint is disabled:"
    curl -A "$USER_AGENT" -sk -X GET "$base/xmlrpc.php"
    exit 1
fi
echo "Endpoint is enabled."
write_step "Retrieve the list of services..."
request_xml="<methodCall><methodName>system.listMethods</methodName><params></params></methodCall>"
curl -sk -X POST -d "<methodCall><methodName>system.listMethods</methodName><params></params></methodCall>" -H "Content-Type: application/xml" "$base/xmlrpc.php" | grep "<string>" | sed 's/<value><string>//g' | sed 's/<\/string><\/value>//g' | tr -d ' ' | sort -u > $WORK_FILE
count=$(wc -l $WORK_FILE | cut -d' ' -f1)
echo "$count services retrieved."
write_step "Identify enabled services..."
while IFS= read -r service
do
  test_service $service $base
done < $WORK_FILE
rm $WORK_FILE
write_step "Check finished."