#!/bin/bash
#####################################################################
# Script to identify information following a pattern 
# in a git repo repository logs
#
# Requirement software:
#   apt install git grep
#####################################################################

if [ "$#" -lt 2 ]; then
    script_name=$(basename "$0")
    echo "Usage:"
    echo "   $script_name [GIT_REPO_LOCATION] [GREP_REGEX_PATTERN] [INCLUDE_REMOTE_BRANCHES_AND_TAGS]"
    echo ""
    echo "Call example:"
    echo "    $script_name /tmp/repo '@gmail.com'"
    echo "    $script_name /tmp/repo '(XXX|YYY)'"
	echo "    $script_name /tmp/repo '(XXX|YYY)' YES"
    exit 1
fi

function write_step(){
    echo -e "\e[93m[+] $1\e[0m"
}

function search_in_logs(){
	git log --pretty=format:"%H - %an - %ae - %s - %aD: %B" | grep --color=always -E "$1"	
}

REPO_LOCATION=$1
EXPR=$2
write_step "Move into git repository location '$REPO_LOCATION'..."
cd $REPO_LOCATION
current_branch=$(git branch --show-current)
if [ "$#" -eq 3 ]; then
	write_step "Retrieve all remote branches and tags..."
	git fetch --all --tags
fi
echo "Currently on $current_branch branch."
write_step "Search pattern '$EXPR' in logs of all branches..."
for b in $(git branch --list | tr '*' ' ')
do
	git checkout $b 2>/dev/null 1>&2
	if [ $? -eq 0 ]; then
		echo "[*] Branch '$b':"
		search_in_logs "$EXPR"	
	fi
done
git checkout $current_branch 
write_step "Search pattern '$EXPR' in logs of all tags in all their branches..."
for t in $(git tag)
do
	git checkout tags/$t 2>/dev/null 1>&2
	if [ $? -eq 0 ]; then
		for b in $(git branch --list | tr '*' ' ')
		do
			git checkout $b 2>/dev/null 1>&2
			if [ $? -eq 0 ]; then
				echo "[*] Tag $t / Branch '$b':"
				search_in_logs "$EXPR"
			fi
		done	
	fi	
done
git checkout $current_branch