#!/bin/bash
##########################################################################################
# Script to generate a eIDAS RSA self-signed certificate and key pair with a Root CA.
##########################################################################################
# See https://enablebanking.com/blog/2020/01/13/how-to-generate-eidas-certificate/
# Files "eidas.conf", "v3.ext", "eidas-ca.conf" are in the "/tools/misc" folder
# Update the "eidas.conf" file to set the target entity identifier
echo "[+] Generate eIDAS CSR..."
rm eidas-* 2>/dev/null
openssl req -new -config /tools/misc/eidas.conf -keyout eidas-http-signature-private.pem -out eidas.csr
echo "[+] Sign CSR with CA (ensure that CA materials is present)..."
openssl ca -config /tools/misc/eidas-ca.conf -out eidas-http-signature-cert.pem -infiles eidas.csr
echo "[+] Finalize materials..."
cert_fingerprint=$(openssl x509 -in eidas-http-signature-cert.pem -noout -fingerprint | cut -d'=' -f2 | tr -d ':' | tr '[:upper:]' '[:lower:]')
cp eidas-http-signature-cert.pem eidas-http-signature-cert.pem_$cert_fingerprint
openssl rsa -in eidas-http-signature-private.pem -pubout -out eidas-http-signature-public.pem
openssl rsa -in eidas-http-signature-private.pem -out eidas-http-signature-private.tmp
mv eidas-http-signature-private.tmp eidas-http-signature-private.pem
rm eidas.csr
echo "[+] eIDAS certificate and key pair generated:"
ls -l eidas-*
