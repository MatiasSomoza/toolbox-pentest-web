import json
import colorama
import sys
from termcolor import colored
from tabulate import tabulate

'''
Quick script to format the result of a NPM Audit JSON report:
    npm audit --json > retire-audit.json
    python generate-report-nom.py retire-audit.json

Dependencies:
    pip install tabulate colorama termcolor
'''
report = sys.argv[1]
colorama.init()
with open(report) as f:
    content = f.read()
v = json.loads(content)
table_headers = ["Severity", "Module name", "CVE"]
table_rows = []
for vid in v["advisories"]:
    f = v["advisories"][vid]
    mod_name = f["module_name"]
    severity = f["severity"].upper()
    if len(f["cves"]) > 0:
        cves = ",".join(f["cves"])
    else:
        cves = "NONE"
    if severity in ["HIGH", "CRITICAL"]:
        severity_color = "red"
    elif severity in ["MEDIUM", "MODERATE"]:
        severity_color = "yellow"
    elif severity == "LOW":
        severity_color = "cyan"
    else:
        severity_color = "white"
    severity = colored(f"{severity}", severity_color, attrs=["bold"])
    table_rows.append([severity, mod_name, cves])
tempo = []
table_rows_depuplicated = []
for row in table_rows:
    k = ""
    for v in row:
        k += v.upper().strip()        
    if k not in tempo:
        tempo.append(k)
        table_rows_depuplicated.append(row)        
table_rows_depuplicated.sort()        
print(tabulate(table_rows_depuplicated, headers=table_headers))
