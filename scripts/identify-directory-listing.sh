#!/bin/bash
#####################################################################
# Script to find directory listing in all links from a HTML page.
#
# Requirement software:
#   htmlq: https://github.com/mgdm/htmlq
#####################################################################

if [ "$#" -lt 1 ]; then
    script_name=$(basename "$0")
    echo "Usage:"
    echo "   $script_name [BASE_URL_WITHOUT_ENDING_SLASH] [DEFAULT_PROTOCOL]"
    echo ""
    echo "[i] DEFAULT_PROTOCOL is optional and default value is https."
    echo ""
    echo "Call example:"
    echo "    $script_name https://righettod.eu"
    echo "    $script_name https://righettod.eu http"
    echo "    $script_name https://righettod.eu/index.jsp"
    echo "    $script_name https://righettod.eu/index.jsp https"
    exit 1
fi

function write_step(){
    echo -e "\e[93m[+] $1\e[0m"
}

check_link () {
	target=$1
	default_proto=$2
	base_target=$3
	proto=${target:0:4}
	if [ "$proto" != "http" ];
	then
		proto=${target:0:2}
		if [ "$proto" == "//" ];
		then
			target="$default_proto:$1"
		else
			target="$base_target/$1"
		fi
	fi
	is_directory_listing_page=$(curl -skL "$target" | grep -Fc "Index of")
	return $is_directory_listing_page
}

extract_parent_folder () {
	parent=$(dirname "$1")
	echo $parent
}

BASE_URL=$1
DEFAULT_PROTOCOL="https"
if [ "$#" -eq 2 ]; then
  DEFAULT_PROTOCOL=$2
fi
write_step "Extract links..."
wget -qO /tmp/page.html $BASE_URL
htmlq -t -f /tmp/page.html --attribute href link > /tmp/links.txt
htmlq -t -f /tmp/page.html --attribute src script >> /tmp/links.txt
htmlq -t -f /tmp/page.html --attribute src img >> /tmp/links.txt
sort -u /tmp/links.txt > /tmp/links2.txt
mv /tmp/links2.txt /tmp/links.txt
directories_with_dl_enabled=()
write_step "Searching for directories with 'directory listing' enabled..."
while IFS= read -r line
do
	parent_folder=$(extract_parent_folder "$line")
	parent_folder_previous="X"
	while [ "$parent_folder" != "$parent_folder_previous" ]
	do
		printf "\rVerifying: %-80s" "$parent_folder/"
		is_directory_listing_page=$(check_link "$parent_folder/" "$DEFAULT_PROTOCOL" "$BASE_URL")
		if [ $? -ne 0 ];
		then
			directories_with_dl_enabled+=( "$parent_folder/" )
		fi		
		parent_folder_previous=$parent_folder
		parent_folder=$(extract_parent_folder "$parent_folder")
	done
done < /tmp/links.txt
printf "\r%-90s" "done."
echo ""
write_step "Directories with 'directory listing' enabled:"
for d in ${directories_with_dl_enabled[@]}; do
  echo $d
done
write_step "Cleanup."
rm /tmp/links.txt /tmp/page.html
