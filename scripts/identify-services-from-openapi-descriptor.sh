#!/bin/bash
#####################################################################
# Script to leverage JQ to extract the list of services (endpoints)
# from an OpenAPI descriptor (JSON format)
#
# Requirement software:
#   apt install jq
#####################################################################

if [ "$#" -lt 1 ]; then
    script_name=$(basename "$0")
    echo "Usage:"
    echo "   $script_name [OPENAPI_DESCRIPTOR_JSON_FILE]"
    echo ""
    echo "Call example:"
    echo "    $script_name openapi.json"
    exit 1
fi

function write_step(){
    echo -e "\e[93m[+] $1\e[0m"
}

OPENAPI_DESCRIPTOR_JSON_FILE=$1
JQ_HANDLER_FILE="/tools/scripts/list-operations.jq"
write_step "API information"
edp_count=$(jq -r -f $JQ_HANDLER_FILE $OPENAPI_DESCRIPTOR_JSON_FILE | wc -l | cut -d' ' -f1)
title=$(jq -r ".info.title" $OPENAPI_DESCRIPTOR_JSON_FILE)
version=$(jq -r ".info.version" $OPENAPI_DESCRIPTOR_JSON_FILE)
echo "Title           : $title"
echo "Version         : $version"
echo "Endpoints count : $edp_count"
write_step "List of endpoints"
jq -r -f $JQ_HANDLER_FILE $OPENAPI_DESCRIPTOR_JSON_FILE
