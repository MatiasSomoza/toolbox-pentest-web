#!/bin/bash
###########################################################################################################
# Script to identify JS libs deployed alongside a web application but not referenced
#
# Use package names from this repository:
#   https://github.com/nice-registry/all-the-package-names/raw/master/names.json
#
# Use dictionary QUICKHITS from SecLists to identify content in the lib folders identified:
#   https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/quickhits.txt
#
# System dependencies to install via the package manager:
#   jq wfuzz
###########################################################################################################
# Utilities functions
function write_step(){
    echo -e "\e[93m[+] $1\e[0m"
}
# Constants
PKG_FILE="/tmp/modules.tmp"
DATA_FILE_JSON="/tmp/data.json"
DATA_FILE_TEXT="/tmp/data.tmp"
GLOBAL_RESULTS="/tmp/data_global.json"
# Entry point
if [ "$#" -lt 3 ]; then
    script_name=$(basename "$0")
    echo "Usage:"
    echo "   $script_name [APP_JS_FOLDER_BASE_URL_WITHOUT_ENDING_SLASH] [PATH_TO_NAMES_JSON_FILE] [PATH_TO_SECLISTS_QUICKHITS_DICT_TXT_FILE] [PACKAGE_COUNT_TAKEN_FROM_NAMES_JSON_FILE]"
    echo ""
    echo "[i] PACKAGE_COUNT_TAKEN_FROM_NAMES_JSON_FILE is optional and default to 10000."
    echo ""
    echo "Call example:"
    echo "    $script_name https://myapp.com/js/vendor /tmp/names.json /tmp/quickhits.txt"
    echo "    $script_name https://myapp.com/js/vendor /tmp/names.json /tmp/quickhits.txt 50000"
    exit 1
fi
APP_JS_FOLDER_BASE_URL=$1
PATH_TO_NAMES_JSON_FILE=$2
PATH_TO_SECLISTS_QUICKHITS_DICT_TXT_FILE=$3
if [ "$#" -eq 4 ]; then
    PKG_LIMIT=$4
else
    PKG_LIMIT="10000"
fi
# Step 01
write_step "Filter package list to the first $PKG_LIMIT having a package name..."
jq ".[0:$PKG_LIMIT]" $PATH_TO_NAMES_JSON_FILE | grep "," | cut -d'"' -f 2 > $PKG_FILE
# Step 02
write_step "Search for them..."
wfuzz -Z -c -f $DATA_FILE_JSON,json -z file,$PKG_FILE --hc 403,404 "$APP_JS_FOLDER_BASE_URL/FUZZ"
jq --raw-output ".[].payload" $DATA_FILE_JSON > $DATA_FILE_TEXT
if [ ! -s $DATA_FILE_TEXT ]; then
    echo "No library found!"
    exit 1
fi
# Step 03
write_step "Search for content into lib folders identified..."
wfuzz -Z -c -f $GLOBAL_RESULTS,json -z file,$DATA_FILE_TEXT -z file,$PATH_TO_SECLISTS_QUICKHITS_DICT_TXT_FILE --hc 403,404 "$APP_JS_FOLDER_BASE_URL/FUZZ/FUZ2Z"
# Step 04
write_step "Valid URL identified:"
jq --raw-output ".[].url" $GLOBAL_RESULTS
# Step 05
write_step "Cleanup..."
rm $PKG_FILE 2>/dev/null
rm $DATA_FILE_JSON 2>/dev/null
rm $DATA_FILE_TEXT 2>/dev/null
rm $GLOBAL_RESULTS 2>/dev/null
exit 0
