#!/bin/bash
##########################################################################################
# Script to generate a eIDAS RSA self-signed certificate and key pair without a Root CA.
##########################################################################################
# See https://enablebanking.com/blog/2020/01/13/how-to-generate-eidas-certificate/
# Files "eidas.conf" and "v3.ext" are in the "/tools/misc" folder
# Update the "eidas.conf" file to set the target entity identifier
echo "[+] Generate eIDAS certificate and key pair..."
rm eidas-* 2>/dev/null
openssl req -new -config /tools/misc/eidas.conf -keyout eidas-http-signature-private.pem -out eidas.csr
openssl x509 -req -in eidas.csr -extfile /tools/misc/v3.ext -signkey eidas-http-signature-private.pem -out eidas-http-signature-cert.pem
cert_fingerprint=$(openssl x509 -in eidas-http-signature-cert.pem -noout -fingerprint | cut -d'=' -f2 | tr -d ':' | tr '[:upper:]' '[:lower:]')
cp eidas-http-signature-cert.pem eidas-http-signature-cert.pem_$cert_fingerprint
openssl rsa -in eidas-http-signature-private.pem -pubout -out eidas-http-signature-public.pem
openssl rsa -in eidas-http-signature-private.pem -out eidas-http-signature-private.tmp
mv eidas-http-signature-private.tmp eidas-http-signature-private.pem
rm eidas.csr
echo "[+] eIDAS certificate and key pair generated:"
ls -l eidas-*
