#!/bin/bash
###########################################################################################################
# Script to create a file containing a release of the Lazagne tool encoded in Base64.
# As Lazagne is detected by Anti-Virus then, it is used to test if a file upload, accepting text data,
# verify if the data is a binary file encoded and then scan it with an Anti-Virus.
#
# References:
#	https://github.com/AlessandroZ/LaZagne/releases/tag/v2.4.5
#
# System dependencies to install via the package manager:
#   apt install wget
###########################################################################################################
###
# Utilities functions
function write_step(){
    echo -e "\e[93m[+] $1\e[0m"
}
# Constants
LAZAGNE_URL="https://github.com/AlessandroZ/LaZagne/releases/download/v2.4.5/LaZagne.exe"
LAZAGNE_FILE="/tmp/lazagne.exe"
RESULT_FILE="/tools/reports/lazagne-b64.txt"
WORK_FILE="/tmp/decoded.bin"
# Entry point
write_step "Retrieve and encode the Lazagne release file..."
if [ ! -f "$LAZAGNE_FILE" ]
then
	wget -q -O $LAZAGNE_FILE $LAZAGNE_URL
fi
base64 -w0 $LAZAGNE_FILE > $RESULT_FILE
echo "Ok."
write_step "Verify the encoded file..."
cat $RESULT_FILE | base64 -d > $WORK_FILE 2>/dev/null
hash_original=$(sha256sum $LAZAGNE_FILE | cut -d' ' -f1)
hash_decoded=$(sha256sum $WORK_FILE | cut -d' ' -f1)
if [ "$hash_original" != "$hash_decoded" ]
then
	echo "Error during the encoding!"
	exit -1
fi
echo "Ok."
write_step "Hashes:"
sha256sum $LAZAGNE_FILE
sha256sum $RESULT_FILE
write_step "File type:"
file $LAZAGNE_FILE
file $RESULT_FILE
write_step "VirusTotal report URL:"
hash=$(sha256sum $LAZAGNE_FILE | cut -d' ' -f1)
echo "https://www.virustotal.com/gui/file/$hash"
rm $WORK_FILE

